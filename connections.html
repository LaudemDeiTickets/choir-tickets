<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connections Check — Laudem Dei Chamber Choir</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .5rem;border-radius:.5rem;font-size:.75rem;font-weight:600}
    .ok{background:#e6f7ef;color:#036146;border:1px solid #b8e6d2}
    .warn{background:#fff5e6;color:#8a4b00;border:1px solid #ffd9a6}
    .err{background:#fdeeee;color:#8a1010;border:1px solid #f5bcbc}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .card{border:1px solid #e5e7eb;border-radius:1rem;padding:1rem}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.5rem .6rem;border-bottom:1px solid #e5e7eb;vertical-align:top}
    .table th{background:#f8fafc;text-align:left;font-weight:600}
    .small{font-size:.85rem}
    .clip{max-width:100%;overflow:auto}
  </style>
</head>
<body class="bg-white text-slate-900">
  <header class="w-full border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">Connections Check</h1>
      <a href="index.html" class="text-sm underline">Back to site</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <section class="card">
      <h2 class="text-lg font-semibold">Targets</h2>
      <p class="small text-slate-600 mt-1">These defaults match your site. You can tweak and re-run.</p>
      <div class="grid-auto mt-4">
        <label class="block">
          <span class="text-sm font-medium text-slate-700">GitHub Pages asset (image/css/js on your site)</span>
          <input id="ghPagesUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url"
                 value="https://laudemdeitickets.github.io/choir-tickets/logo.jpeg?v=18">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">GitHub Raw asset (raw.githubusercontent.com)</span>
          <input id="ghRawUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url"
                 value="https://raw.githubusercontent.com/LaudemDeiTickets/choir-tickets/main/backdrop.jpg">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Google Sheets (Published CSV)</span>
          <input id="sheetsCsvUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url"
                 value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQZ2u4btRm1YXAF05T_52qklU_TSVDajyCmoIbIcWUm_GANZkJ1mM5aHuDg2B959kTrUKTUBQyHhQnv/pub?gid=2017023192&single=true&output=csv">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Extra URL to test (optional)</span>
          <input id="extraUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url" placeholder="https://…">
        </label>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="runBtn" class="px-4 py-2 rounded-xl bg-sky-600 text-white font-semibold">Run Checks</button>
        <button id="copyBtn" class="px-4 py-2 rounded-xl border border-slate-300">Copy debug</button>
      </div>
    </section>

    <section class="card">
      <h2 class="text-lg font-semibold">Results</h2>
      <div id="results" class="mt-3 space-y-4">
        <p class="text-slate-500 small">Click “Run Checks”.</p>
      </div>
    </section>
  </main>

  <script>
    // ---------- helpers ----------
    const qs = (s, r=document) => r.querySelector(s);
    const el = (tag, cls, html) => { const n = document.createElement(tag); if (cls) n.className = cls; if (html!=null) n.innerHTML = html; return n; };
    const toK = b => (b/1024).toFixed(1) + " KB";

    async function timed(fn){
      const t0 = performance.now();
      try {
        const res = await fn();
        const t1 = performance.now();
        return { ok:true, ms: (t1 - t0), data: res };
      } catch (e) {
        const t1 = performance.now();
        return { ok:false, ms: (t1 - t0), error: e };
      }
    }

    // robust CSV parser
    function parseCSV(text){
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const rows = [];
      let cur = [], val = "", inQuotes = false;
      for (let i=0;i<text.length;i++){
        const ch=text[i], next=text[i+1];
        if (inQuotes){
          if (ch === '"' && next === '"'){ val += '"'; i++; }
          else if (ch === '"'){ inQuotes = false; }
          else { val += ch; }
        } else {
          if (ch === '"') { inQuotes = true; }
          else if (ch === ',') { cur.push(val.trim()); val=""; }
          else if (ch === '\n') { cur.push(val.trim()); rows.push(cur); cur=[]; val=""; }
          else if (ch === '\r') { /* ignore */ }
          else { val += ch; }
        }
      }
      if (val.length || cur.length){ cur.push(val.trim()); rows.push(cur); }
      return rows;
    }

    function rowsToObjects(rows){
      if (!rows.length) return [];
      const headers = rows[0].map(h => (h||"").trim());
      return rows.slice(1).map(r => {
        const o={}; headers.forEach((h,i)=>o[h]=r[i]??""); return o;
      });
    }

    function statusBadge(kind, text){
      const span = el('span', `badge ${kind}`);
      span.textContent = text;
      return span;
    }

    function renderKV(title, kv){
      const wrap = el('div', 'card');
      wrap.appendChild(el('div', 'flex items-center justify-between gap-3 mb-2',
        `<div class="font-semibold">${title}</div>`));
      const table = el('table', 'table small mono');
      const thead = el('thead'); thead.innerHTML = `<tr><th>Key</th><th>Value</th></tr>`;
      const tbody = el('tbody');
      Object.entries(kv).forEach(([k,v])=>{
        const tr = el('tr');
        tr.appendChild(el('td', '', k));
        tr.appendChild(el('td', 'clip', v));
        tbody.appendChild(tr);
      });
      table.appendChild(thead); table.appendChild(tbody); wrap.appendChild(table);
      return wrap;
    }

    // ---------- checks ----------
    async function checkFetch(url){
      const r = await fetch(url, { cache: 'no-store' });
      const ct = r.headers.get('content-type') || '';
      const ab = await r.arrayBuffer(); // works if CORS allows; otherwise it will still work for CORS-enabled
      return {
        ok: r.ok,
        status: r.status + " " + r.statusText,
        type: ct,
        size: ab.byteLength,
      };
    }

    async function checkImage(url){
      // Just try to load the image element; more tolerant than fetch for some CORS setups
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.referrerPolicy = "no-referrer";
      return await new Promise((resolve) => {
        const t0 = performance.now();
        img.onload = () => resolve({ ok:true, status:"loaded", width: img.naturalWidth, height: img.naturalHeight, ms: performance.now()-t0 });
        img.onerror = (e) => resolve({ ok:false, status:"error loading image", ms: performance.now()-t0, error: String(e?.message||e) });
        img.src = url + (url.includes('?') ? '&' : '?') + '_t=' + Date.now();
      });
    }

    async function checkCsv(url){
      const r = await fetch(url, { cache: 'no-store' });
      const text = await r.text();
      const rows = parseCSV(text);
      const objs = rowsToObjects(rows);
      return {
        ok: r.ok,
        status: r.status + " " + r.statusText,
        rows: rows.length,
        columns: rows[0]?.length || 0,
        headers: rows[0] || [],
        sample: objs.slice(0,3),
        rawSize: text.length
      };
    }

    // ---------- UI wiring ----------
    const resultsEl = qs('#results');
    let lastDebug = {};

    function addResultBlock(title, outcome, extras={}){
      const block = el('div', 'card');
      const header = el('div', 'flex items-center justify-between gap-3 mb-2');
      const left = el('div', 'font-semibold', title);
      const right = el('div', 'space-x-2');
      right.appendChild(statusBadge(outcome.ok ? 'ok' : 'err', outcome.ok ? 'OK' : 'ERROR'));
      right.appendChild(statusBadge('warn', Math.round(outcome.ms) + ' ms'));
      header.appendChild(left); header.appendChild(right);
      block.appendChild(header);

      const table = el('table', 'table small mono');
      const tbody = el('tbody');
      Object.entries(extras).forEach(([k,v])=>{
        const tr = el('tr');
        const val = (typeof v === 'string') ? v : JSON.stringify(v, null, 2);
        tr.innerHTML = `<td>${k}</td><td class="clip"><pre class="mono small">${val}</pre></td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      block.appendChild(table);
      resultsEl.appendChild(block);
    }

    async function run(){
      resultsEl.innerHTML = '';
      lastDebug = { startedAt: new Date().toISOString(), userAgent: navigator.userAgent, origin: location.origin, checks: [] };

      const ghPagesUrl = qs('#ghPagesUrl').value.trim();
      const ghRawUrl   = qs('#ghRawUrl').value.trim();
      const csvUrl     = qs('#sheetsCsvUrl').value.trim();
      const extraUrl   = qs('#extraUrl').value.trim();

      // GitHub Pages asset (use <img> load for a true rendering check)
      const ghPagesRes = await timed(() => checkImage(ghPagesUrl));
      addResultBlock('GitHub Pages asset', ghPagesRes, ghPagesRes.ok
        ? { url: ghPagesUrl, size: `${ghPagesRes.width}×${ghPagesRes.height}`, timeMs: Math.round(ghPagesRes.ms) }
        : { url: ghPagesUrl, error: ghPagesRes.status, timeMs: Math.round(ghPagesRes.ms) });
      lastDebug.checks.push({ name:'github_pages_image', url: ghPagesUrl, ...ghPagesRes });

      // GitHub Raw asset (try fetch for headers/size)
      const rawRes = await timed(() => checkFetch(ghRawUrl));
      addResultBlock('GitHub Raw asset', rawRes, {
        url: ghRawUrl,
        http: rawRes.data.status,
        contentType: rawRes.data.type,
        size: toK(rawRes.data.size)
      });
      lastDebug.checks.push({ name:'github_raw_fetch', url: ghRawUrl, ...rawRes });

      // Google Sheets CSV
      const csvRes = await timed(() => checkCsv(csvUrl));
      addResultBlock('Google Sheets — Published CSV', csvRes, csvRes.ok ? {
        url: csvUrl,
        http: csvRes.data.status,
        rows: csvRes.data.rows,
        columns: csvRes.data.columns,
        headers: csvRes.data.headers,
        sample: csvRes.data.sample,
        sizeChars: csvRes.data.rawSize
      } : { url: csvUrl, error: String(csvRes.error) });
      lastDebug.checks.push({ name:'sheets_csv', url: csvUrl, ...csvRes });

      // Extra URL (optional)
      if (extraUrl){
        const extraRes = await timed(() => checkFetch(extraUrl));
        addResultBlock('Extra URL', extraRes, extraRes.ok ? {
          url: extraUrl,
          http: extraRes.data.status,
          contentType: extraRes.data.type,
          size: toK(extraRes.data.size)
        } : { url: extraUrl, error: String(extraRes.error) });
        lastDebug.checks.push({ name:'extra_fetch', url: extraUrl, ...extraRes });
      }

      // Tips if issues found
      const anyErr = lastDebug.checks.some(c => !c.ok);
      if (anyErr){
        const tips = el('div', 'card');
        tips.innerHTML = `
          <div class="font-semibold mb-1">Troubleshooting tips</div>
          <ul class="list-disc pl-5 small text-slate-700">
            <li><strong>Google Sheets:</strong> ensure the sheet/tab is <em>Published to the web</em> and the URL uses <code>output=csv</code> for the correct <code>gid</code>.</li>
            <li><strong>CORS:</strong> tests use <code>fetch</code>. If a resource blocks CORS you may see “Failed to fetch”. Try opening the URL directly in a new tab to verify reachability.</li>
            <li><strong>Cache:</strong> hard refresh this page (Ctrl/Cmd+Shift+R).</li>
            <li><strong>Permissions:</strong> Google Drive links that aren’t “Anyone with the link” will fail.</li>
          </ul>`;
        resultsEl.appendChild(tips);
      }
    }

    qs('#runBtn').addEventListener('click', run);
    qs('#copyBtn').addEventListener('click', async ()=>{
      try {
        await navigator.clipboard.writeText(JSON.stringify(lastDebug, null, 2));
        qs('#copyBtn').textContent = 'Copied!';
        setTimeout(()=>qs('#copyBtn').textContent='Copy debug', 1200);
      } catch {
        alert('Copy failed. Select and copy manually from console.');
        console.log(lastDebug);
      }
    });

    // auto-run on load
    document.addEventListener('DOMContentLoaded', run, { once:true });
  </script>
</body>
</html>
