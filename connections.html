<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connections Check — Choir Tickets</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .5rem;border-radius:.5rem;font-size:.75rem;font-weight:600}
    .ok{background:#e6f7ef;color:#036146;border:1px solid #b8e6d2}
    .warn{background:#fff5e6;color:#8a4b00;border:1px solid #ffd9a6}
    .err{background:#fdeeee;color:#8a1010;border:1px solid #f5bcbc}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .card{border:1px solid #e5e7eb;border-radius:1rem;padding:1rem}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.5rem .6rem;border-bottom:1px solid #e5e7eb;vertical-align:top}
    .table th{background:#f8fafc;text-align:left;font-weight:600}
    .small{font-size:.85rem}
    .clip{max-width:100%;overflow:auto}
  </style>
</head>
<body class="bg-white text-slate-900">
  <header class="w-full border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">Connections Check</h1>
      <a href="index.html" class="text-sm underline">Back to site</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <!-- CONFIG -->
    <section class="card">
      <h2 class="text-lg font-semibold">Configure Endpoints</h2>
      <p class="small text-slate-600 mt-1">CSV links (read-only) per sheet and your Apps Script Web App (read/write).</p>
      <div class="grid-auto mt-4">
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Events CSV</span>
          <input id="eventsCsvUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url"
                 value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQZ2u4btRm1YXAF05T_52qklU_TSVDajyCmoIbIcWUm_GANZkJ1mM5aHuDg2B959kTrUKTUBQyHhQnv/pub?gid=2017023192&single=true&output=csv">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Pricing CSV</span>
          <input id="pricingCsvUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url"
                 value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQZ2u4btRm1YXAF05T_52qklU_TSVDajyCmoIbIcWUm_GANZkJ1mM5aHuDg2B959kTrUKTUBQyHhQnv/pub?gid=58928849&single=true&output=csv">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Settings CSV</span>
          <input id="settingsCsvUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url"
                 value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQZ2u4btRm1YXAF05T_52qklU_TSVDajyCmoIbIcWUm_GANZkJ1mM5aHuDg2B959kTrUKTUBQyHhQnv/pub?gid=1700312947&single=true&output=csv">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Tickets CSV</span>
          <input id="ticketsCsvUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url"
                 value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQZ2u4btRm1YXAF05T_52qklU_TSVDajyCmoIbIcWUm_GANZkJ1mM5aHuDg2B959kTrUKTUBQyHhQnv/pub?gid=1217953546&single=true&output=csv">
        </label>
      </div>

      <div class="grid-auto mt-4">
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Apps Script Web App URL</span>
          <input id="appsScriptUrl" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="url"
                 placeholder="https://script.google.com/macros/s/XXX/exec">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">API Token (optional)</span>
          <input id="apiToken" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="text"
                 placeholder="Bearer token if enabled in Apps Script">
        </label>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="runReadsBtn" class="px-4 py-2 rounded-xl bg-sky-600 text-white font-semibold">Run Read Checks</button>
        <button id="copyBtn" class="px-4 py-2 rounded-xl border border-slate-300">Copy debug</button>
      </div>
    </section>

    <!-- READ RESULTS -->
    <section class="card">
      <h2 class="text-lg font-semibold">Read Results</h2>
      <div id="readResults" class="mt-3 space-y-4">
        <p class="text-slate-500 small">Click “Run Read Checks”.</p>
      </div>
    </section>

    <!-- WRITE TESTS -->
    <section class="card">
      <h2 class="text-lg font-semibold">Write Tests (Apps Script)</h2>
      <p class="small text-slate-600">These call your Web App to write to the same spreadsheet. Use in test mode where possible.</p>

      <div class="grid-auto mt-4">
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Diagnostic Event ID</span>
          <input id="testEventId" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="text" value="DIAG-EVENT">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Buyer (name,email,phone)</span>
          <input id="testBuyer" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="text" value="Diagnostics Bot,bot@example.com,+27 10 000 0000">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Ticket Item(s)</span>
          <input id="testItems" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" type="text" value='[{"code":"TEST","qty":1,"priceCents":0}]'>
          <span class="small text-slate-500">JSON array; <code>priceCents</code> optional—server can store as-is.</span>
        </label>
      </div>

      <div class="mt-4 flex flex-wrap gap-3">
        <button id="writeTicketBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold">Append Ticket (Tickets)</button>
        <button id="writeEventBtn"  class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold">Upsert Event (Events)</button>
        <button id="writePriceBtn"  class="px-4 py-2 rounded-xl bg-violet-600 text-white font-semibold">Upsert Price (Pricing)</button>
        <button id="writeSettingBtn"class="px-4 py-2 rounded-xl bg-amber-600 text-white font-semibold">Upsert Setting (Settings)</button>
      </div>

      <div id="writeResults" class="mt-3 space-y-4">
        <p class="text-slate-500 small">Write results will appear here.</p>
      </div>
    </section>
  </main>

  <script>
    // ---------- helpers ----------
    const qs = (s, r=document) => r.querySelector(s);
    const el = (tag, cls, html) => { const n = document.createElement(tag); if (cls) n.className = cls; if (html!=null) n.innerHTML = html; return n; };
    const toK = b => (b/1024).toFixed(1) + " KB";

    async function timed(fn){
      const t0 = performance.now();
      try {
        const res = await fn();
        const t1 = performance.now();
        return { ok:true, ms: (t1 - t0), data: res };
      } catch (e) {
        const t1 = performance.now();
        return { ok:false, ms: (t1 - t0), error: e };
      }
    }

    // robust CSV parser
    function parseCSV(text){
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const rows = [];
      let cur = [], val = "", inQuotes = false;
      for (let i=0;i<text.length;i++){
        const ch=text[i], next=text[i+1];
        if (inQuotes){
          if (ch === '"' && next === '"'){ val += '"'; i++; }
          else if (ch === '"'){ inQuotes = false; }
          else { val += ch; }
        } else {
          if (ch === '"') { inQuotes = true; }
          else if (ch === ',') { cur.push(val.trim()); val=""; }
          else if (ch === '\n') { cur.push(val.trim()); rows.push(cur); cur=[]; val=""; }
          else if (ch === '\r') { /* ignore */ }
          else { val += ch; }
        }
      }
      if (val.length || cur.length){ cur.push(val.trim()); rows.push(cur); }
      return rows;
    }

    function rowsToObjects(rows){
      if (!rows.length) return [];
      const headers = rows[0].map(h => (h||"").trim());
      return rows.slice(1).map(r => {
        const o={}; headers.forEach((h,i)=>o[h]=r[i]??""); return o;
      });
    }

    function statusBadge(kind, text){
      const span = el('span', `badge ${kind}`);
      span.textContent = text;
      return span;
    }

    function addBlock(container, title, outcome, extras={}){
      const block = el('div', 'card');
      const header = el('div', 'flex items-center justify-between gap-3 mb-2');
      const left = el('div', 'font-semibold', title);
      const right = el('div', 'space-x-2');
      right.appendChild(statusBadge(outcome.ok ? 'ok' : 'err', outcome.ok ? 'OK' : 'ERROR'));
      right.appendChild(statusBadge('warn', Math.round(outcome.ms) + ' ms'));
      header.appendChild(left); header.appendChild(right);
      block.appendChild(header);

      const table = el('table', 'table small mono');
      const tbody = el('tbody');
      Object.entries(extras).forEach(([k,v])=>{
        const tr = el('tr');
        const val = (typeof v === 'string') ? v : JSON.stringify(v, null, 2);
        tr.innerHTML = `<td>${k}</td><td class="clip"><pre class="mono small">${val}</pre></td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      block.appendChild(table);
      container.appendChild(block);
    }

    // ---------- READ CHECKS ----------
    async function fetchCsv(url){
      const r = await fetch(url, { cache: 'no-store' });
      const text = await r.text();
      const rows = parseCSV(text);
      const objs = rowsToObjects(rows);
      return { http: r.status + ' ' + r.statusText, rows: rows.length, columns: rows[0]?.length||0, headers: rows[0]||[], sample: objs.slice(0,3), sizeChars: text.length };
    }

    async function runReads(){
      const readsEl = qs('#readResults');
      readsEl.innerHTML = '';

      const urls = [
        { name: 'Events CSV',   val: qs('#eventsCsvUrl').value.trim() },
        { name: 'Pricing CSV',  val: qs('#pricingCsvUrl').value.trim() },
        { name: 'Settings CSV', val: qs('#settingsCsvUrl').value.trim() },
        { name: 'Tickets CSV',  val: qs('#ticketsCsvUrl').value.trim() },
      ];

      for (const u of urls){
        const res = await timed(() => fetchCsv(u.val));
        addBlock(readsEl, u.name, res, res.ok ? res.data : { url: u.val, error: String(res.error) });
      }
    }

    // ---------- WRITE TESTS ----------
    function getApiInfo(){
      return {
        url: qs('#appsScriptUrl').value.trim(),
        token: qs('#apiToken').value.trim()
      };
    }
    async function apiPost(payload){
      const { url, token } = getApiInfo();
      if (!url) throw new Error('Apps Script URL is required for writes.');
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const r = await fetch(url, { method: 'POST', headers, body: JSON.stringify(payload) });
      const txt = await r.text(); let json; try { json = JSON.parse(txt); } catch { json = { ok: r.ok, raw: txt }; }
      return json;
    }

    function parseBuyer(str){
      // "Name,email,phone"
      const [name, email, phone] = String(str||'').split(',').map(s=>s.trim());
      return { name: name||'', email: email||'', phone: phone||'' };
    }

    async function testAppendTicket(){
      const writeEl = qs('#writeResults');
      const eventId = qs('#testEventId').value.trim() || 'DIAG-EVENT';
      const buyer   = parseBuyer(qs('#testBuyer').value);
      let items; try { items = JSON.parse(qs('#testItems').value); } catch { items = [{code:'TEST',qty:1,priceCents:0}]; }
      const totalCents = items.reduce((s,i)=> s + (Number(i.priceCents)||0) * (Number(i.qty)||0), 0);

      const payload = {
        action: 'appendTicket',
        eventId,
        buyer,
        items,
        totalCents,
        notes: 'diagnostic write from connections.html ' + new Date().toISOString()
      };

      const res = await timed(() => apiPost(payload));
      addBlock(writeEl, 'Append Ticket → Tickets', res, res.ok ? res.data : { error: String(res.error), payload });
    }

    async function testUpsertEvent(){
      const writeEl = qs('#writeResults');
      const now = new Date();
      const iso = new Date(now.getTime() + 7*24*3600*1000).toISOString(); // +7 days
      const payload = {
        action: 'upsertEvent',
        row: {
          id: 'DIAG-EVENT',
          title: 'Diagnostics Event',
          subtitle: 'Created by connections.html',
          startISO: iso,
          endISO: new Date(now.getTime() + 7*24*3600*1000 + 2*3600*1000).toISOString(),
          venue: 'Diagnostics Hall',
          address: '123 Test Rd, Debug City',
          image: '',
          href: 'iwelcome.html',
          active: 'TRUE'
        }
      };
      const res = await timed(() => apiPost(payload));
      addBlock(writeEl, 'Upsert Event → Events', res, res.ok ? res.data : { error: String(res.error), payload });
    }

    async function testUpsertPrice(){
      const writeEl = qs('#writeResults');
      const payload = {
        action: 'upsertPricing',
        rows: [{ code:'TEST', name:'Diagnostics Ticket', priceCents:0, desc:'For testing', limit: 999 }]
      };
      const res = await timed(() => apiPost(payload));
      addBlock(writeEl, 'Upsert Price → Pricing', res, res.ok ? res.data : { error: String(res.error), payload });
    }

    async function testUpsertSetting(){
      const writeEl = qs('#writeResults');
      const payload = { action: 'upsertSetting', key:'lastDiagnostics', value:new Date().toISOString() };
      const res = await timed(() => apiPost(payload));
      addBlock(writeEl, 'Upsert Setting → Settings', res, res.ok ? res.data : { error: String(res.error), payload });
    }

    // ---------- Wire buttons ----------
    qs('#runReadsBtn').addEventListener('click', runReads);
    qs('#copyBtn').addEventListener('click', async ()=>{
      try {
        await navigator.clipboard.writeText(JSON.stringify({ ts:new Date().toISOString(), ua:navigator.userAgent }, null, 2));
        qs('#copyBtn').textContent = 'Copied!';
        setTimeout(()=>qs('#copyBtn').textContent='Copy debug', 1200);
      } catch { alert('Copy failed.'); }
    });

    qs('#writeTicketBtn').addEventListener('click', testAppendTicket);
    qs('#writeEventBtn').addEventListener('click', testUpsertEvent);
    qs('#writePriceBtn').addEventListener('click', testUpsertPrice);
    qs('#writeSettingBtn').addEventListener('click', testUpsertSetting);
  </script>
</body>
</html>
