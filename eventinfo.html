<script>
  // --- Config / constants ---
  const STORAGE_KEYS = {
    CONFIG: 'choir_config_override',
    CART: 'choir_cart',
    SELECTED: 'choir_selected_event'
  };

  // Published CSV (Web > Publish to the web)
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZ2u4btRm1YXAF05T_52qklU_TSVDajyCmoIbIcWUm_GANZkJ1mM5aHuDg2B959kTrUKTUBQyHhQnv/pub?gid=2017023192&single=true&output=csv";

  // Default/fallback config
  function loadDefaultConfig(){
    const def = {
      orgName: "Laudem Dei Chamber Choir",
      logoUrl: "https://laudemdeitickets.github.io/choir-tickets/logo.jpeg",
      event: {
        id:"choir-2025-spring-concert",
        title:"Spring Serenade Concert",
        subtitle:"An evening of choral gems",
        dateISO:"2025-10-11T18:30:00+02:00",
        doorsISO:"2025-10-11T18:00:00+02:00",
        venue:"St. Stithians Chapel",
        address:"40 Peter Place, Lyme Park, Sandton, 2191",
        mapLink:"https://maps.google.com/?q=St.+Stithians+Chapel+Sandton",
        heroImg:"https://placehold.co/1200x800/png?text=Choir+Concert",
        heroAlt:"Choir on stage"
      },
      tickets: [
        { code:"GEN",  name:"General Admission",    price:20000, desc:"Unreserved seating", limit:10 },
        { code:"STUD", name:"Student / Pensioner", price:12000, desc:"ID required at door", limit:10 },
        { code:"VIP",  name:"Patron (Front Rows)", price:35000, desc:"Priority seating + program", limit:10 }
      ]
    };
    try {
      const s = localStorage.getItem(STORAGE_KEYS.CONFIG);
      if (s){
        const o = JSON.parse(s);
        Object.assign(def, o);
        if (o.event) Object.assign(def.event, o.event);
        if (o.tickets) def.tickets = o.tickets;
      }
    } catch(_){}
    return def;
  }
  const CONFIG = loadDefaultConfig();

  // --- Helpers ---
  const ZAR = new Intl.NumberFormat('en-ZA',{style:'currency',currency:'ZAR',maximumFractionDigits:0});
  const fmt = (cents)=>ZAR.format(cents/100);
  const qs=(s,r)=> (r||document).querySelector(s);
  const qsa=(s,r)=> Array.from((r||document).querySelectorAll(s));
  const toHuman=(iso)=> new Intl.DateTimeFormat(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}).format(new Date(iso));
  function getParam(name){ return new URL(location.href).searchParams.get(name); }

  // CSV parsing (robust + BOM tolerant)
  function parseCSV(text) {
    // strip BOM if present
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const rows = [];
    let cur = [], val = "", inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const ch = text[i], next = text[i+1];
      if (inQuotes) {
        if (ch === '"' && next === '"') { val += '"'; i++; }
        else if (ch === '"') { inQuotes = false; }
        else { val += ch; }
      } else {
        if (ch === '"') { inQuotes = true; }
        else if (ch === ',') { cur.push(val.trim()); val = ""; }
        else if (ch === '\n') { cur.push(val.trim()); rows.push(cur); cur = []; val = ""; }
        else if (ch === '\r') { /* ignore */ }
        else { val += ch; }
      }
    }
    if (val.length || cur.length) { cur.push(val.trim()); rows.push(cur); }
    return rows;
  }

  // Make headers case/space-insensitive: "Event ID" -> "eventid", "Start ISO" -> "startiso"
  function normalizeKey(k){ return String(k||"").trim().toLowerCase().replace(/\s+/g,''); }

  function rowsToObjects(rows) {
    if (!rows.length) return [];
    const headers = rows[0].map(h => normalizeKey(h));
    return rows.slice(1).map(r => {
      const o = {};
      headers.forEach((h, i) => { o[h] = (r[i] ?? "").trim(); });
      return o;
    });
  }

  // Pick the first non-empty value from possible key variants
  function pick(o, keys){
    for (const k of keys){ const nk = normalizeKey(k); if (o[nk]) return o[nk]; }
    return "";
  }

  function normalizeEventRow(obj){
    // Accept common variants
    const id        = pick(obj, ["id","eventid","slug"]);
    const title     = pick(obj, ["title","name","eventtitle"]);
    const subtitle  = pick(obj, ["subtitle","tagline","sub"]);
    const startISO  = pick(obj, ["startiso","start","dateiso","datetime","date","starttime"]);
    const doorsISO  = pick(obj, ["doorsiso","doors","doortime","opentime","startiso","start"]);
    const venue     = pick(obj, ["venue","location","place","hall"]);
    const address   = pick(obj, ["address","addr","street"]);
    const mapLink   = pick(obj, ["maplink","map","maps"]);
    const image     = pick(obj, ["image","heroimg","banner","photo","img"]);
    const heroAlt   = pick(obj, ["heroalt","alt","title"]);

    return {
      id:       id || "",
      title:    title || "Event",
      subtitle: subtitle || "",
      dateISO:  startISO || "",
      doorsISO: doorsISO || startISO || "",
      venue:    venue || "",
      address:  address || "",
      mapLink:  mapLink || (address ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}` : "#"),
      heroImg:  image || "https://raw.githubusercontent.com/LaudemDeiTickets/choir-tickets/main/backdrop.jpg",
      heroAlt:  heroAlt || title || "Event image"
    };
  }

  // Try to load selected event: sessionStorage first, then ?id=... from CSV, else fallback
  async function resolveSelectedEvent(){
    // 1) sessionStorage
    try {
      const s = sessionStorage.getItem(STORAGE_KEYS.SELECTED);
      if (s) {
        const ev = JSON.parse(s);
        console.info("[eventinfo] Using event from sessionStorage.");
        return normalizeEventRow(ev);
      }
    } catch(err){
      console.warn("[eventinfo] sessionStorage parse failed:", err);
    }

    // 2) Query string id -> CSV
    const idParam = (getParam('id') || getParam('event') || getParam('e') || "").trim();
    if (idParam){
      try {
        const res = await fetch(CSV_URL, { cache: "no-cache" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        const rows = parseCSV(text);
        const objs = rowsToObjects(rows);
        const match = objs.find(o => String(pick(o,["id","eventid","slug"])).toLowerCase() === idParam.toLowerCase());
        if (match){
          console.info("[eventinfo] Matched event id:", idParam);
          return normalizeEventRow(match);
        } else {
          console.warn("[eventinfo] No row with id =", idParam, "Check your Sheet's ID column.");
        }
      } catch (e) {
        console.error("[eventinfo] Failed to load CSV:", e);
      }
    } else {
      console.warn("[eventinfo] No ?id=… provided in URL. Falling back to default config.");
    }

    // 3) Fallback
    return CONFIG.event;
  }

  // --- UI Rendering ---
  const cart = new Map();

  function applyEventToUI(ev){
    CONFIG.event = { ...CONFIG.event, ...ev };

    // Header/logo
    qs('#brandLogo').src = CONFIG.logoUrl;
    qs('#brandLogo').setAttribute('crossorigin','anonymous');

    // Event details
    qs('#eventTitle').textContent = CONFIG.event.title || '';
    qs('#eventSubtitle').textContent = CONFIG.event.subtitle || '';
    qs('#venue').textContent = CONFIG.event.venue || '';
    qs('#venueLink').href = CONFIG.event.mapLink || '#';
    qs('#dateHuman').textContent = CONFIG.event.dateISO ? toHuman(CONFIG.event.dateISO) : '';
    qs('#doorsHuman').textContent = CONFIG.event.doorsISO
      ? new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(new Date(CONFIG.event.doorsISO))
      : '';
    const img = qs('#heroImg');
    img.src = CONFIG.event.heroImg || '';
    img.alt = CONFIG.event.heroAlt || 'Event image';
  }

  function renderTickets(){
    const grid=qs('#ticketGrid'); grid.innerHTML='';
    CONFIG.tickets.forEach(t=>{
      const card=document.createElement('div');
      card.className='rounded-2xl border border-slate-200 p-6';
      card.innerHTML=`
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">${t.name}</div>
          <div class="text-xl font-bold">${fmt(t.price)}</div>
        </div>
        <p class="mt-1 text-sm text-slate-600">${t.desc||''}</p>
        <div class="mt-3 flex items-center gap-2">
          <button data-code="${t.code}" class="qtyDown px-3 py-2 rounded-lg border">−</button>
          <input data-code="${t.code}" type="number" min="0" max="${t.limit||99}" value="0" class="qtyInput w-16 text-center border rounded-lg py-2">
          <button data-code="${t.code}" class="qtyUp px-3 py-2 rounded-lg border">+</button>
        </div>`;
      grid.appendChild(card);
    });
    qsa('.qtyUp').forEach(b=>b.addEventListener('click',()=>changeQty(b.dataset.code,1)));
    qsa('.qtyDown').forEach(b=>b.addEventListener('click',()=>changeQty(b.dataset.code,-1)));
    qsa('.qtyInput').forEach(i=>i.addEventListener('input',()=>setQty(i.dataset.code,parseInt(i.value||'0',10))));
  }

  function setQty(code, qty){
    const t=CONFIG.tickets.find(x=>x.code===code);
    const clamp=Math.max(0, Math.min(qty||0, t.limit||99));
    if (clamp===0) cart.delete(code); else cart.set(code, clamp);
    qsa(`.qtyInput[data-code="${code}"]`).forEach(i=>i.value=clamp);
    renderOrder();
  }
  function changeQty(code,d){ setQty(code,(cart.get(code)||0)+d); }
  function totals(){ let total=0; cart.forEach((q,code)=>{ const t=CONFIG.tickets.find(x=>x.code===code); total += t.price*q; }); return { total }; }
  function renderOrder(){
    const list=qs('#orderList'); list.innerHTML='';
    if (cart.size===0) list.innerHTML='<p class="text-slate-500">No tickets selected yet.</p>';
    else cart.forEach((qty,code)=>{ const t=CONFIG.tickets.find(x=>x.code===code); const row=document.createElement('div'); row.className='flex items-center justify-between'; row.innerHTML=`<span class="text-sm">${t.name} × ${qty}</span><span class="text-sm font-medium">${fmt(t.price*qty)}</span>`; list.appendChild(row); });
    const { total }=totals(); qs('#total').textContent=fmt(total); qs('#goCheckout').disabled = !(total>0);
  }

  function goCheckout(){
    const items = Array.from(cart.entries()).map(([code,qty])=>({code,qty}));
    const payload = { items, savedAt: Date.now(), eventId: CONFIG.event.id || null };
    try { localStorage.setItem(STORAGE_KEYS.CART, JSON.stringify(payload)); } catch(_){}
    const qsId = CONFIG.event.id ? `?id=${encodeURIComponent(CONFIG.event.id)}` : '';
    window.location.href = 'checkout.html' + qsId;
  }

  async function boot(){
    const ev = await resolveSelectedEvent();
    applyEventToUI(ev);
    renderTickets(); renderOrder();
    qs('#goCheckout').addEventListener('click', goCheckout);
  }
  document.addEventListener('DOMContentLoaded', boot, { once:true });
</script>
