<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laudem Dei Chamber Choir ‚Äî Tickets</title>
  <meta name="description" content="Buy tickets for Laudem Dei Chamber Choir. Secure card payments via Yoco (test mode enabled)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root { --brand:#0ea5e9; --brand-600:#0284c7; --brand-700:#0369a1; }
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; }
    .glass { background: rgba(255,255,255,.7); backdrop-filter: blur(10px); }
    .ticket-card:hover { box-shadow: 0 10px 24px rgba(2,132,199,.15); transform: translateY(-1px); }
    .badge { background: #e0f2fe; color:#075985; }
    .gradient-hero { background: radial-gradient(1200px 600px at 10% 10%, #bae6fd 0%, rgba(186,230,253,0) 50%),
                                   radial-gradient(1200px 600px at 90% -10%, #e9d5ff 0%, rgba(233,213,255,0) 55%),
                                   linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); }
  </style>
</head>
<body class="bg-white text-slate-800">
  <script>
    // ===== CONFIG (re-using the original themed layout) =====
    const CONFIG = {
      orgName: "Laudem Dei Chamber Choir",
      supportEmail: "tickets@laudemdei.org.za",
      event: {
        id: "choir-2025-spring-concert",
        title: "Spring Serenade Concert",
        subtitle: "An evening of choral gems",
        dateISO: "2025-10-11T18:30:00+02:00",
        doorsISO: "2025-10-11T18:00:00+02:00",
        venue: "St. Stithians Chapel",
        address: "40 Peter Place, Lyme Park, Sandton, 2191",
        mapLink: "https://maps.google.com/?q=St.+Stithians+Chapel+Sandton",
        heroImg: "https://placehold.co/1600x900/png?text=Choir+Concert",
        heroAlt: "Choir on stage"
      },
      tickets: [
        { code: "GEN",  name: "General Admission",    price: 20000,  desc: "Unreserved seating",          limit: 10, fee: 0 },
        { code: "STUD", name: "Student / Pensioner", price: 12000,  desc: "ID required at door",        limit: 10, fee: 0 },
        { code: "VIP",  name: "Patron (Front Rows)", price: 35000,  desc: "Priority seating + program", limit: 10, fee: 0 }
      ],
      yoco: { mode: 'payment_link', paymentLinks: { GEN:'#', STUD:'#', VIP:'#' }, checkoutEndpoint: '/checkout_create.php' },
      currency: 'ZAR',
      testMode: true,
      simulateCheckout: true // critical for bypassing real Yoco during tests
    };
  </script>

  <!-- Test Mode Banner -->
  <div id="testBanner" class="bg-amber-100 border-b border-amber-200 text-amber-900 text-sm py-2">
    <div class="max-w-5xl mx-auto px-4">Test mode is ON ‚Äî mock checkout is enabled. Replace links and set <code>simulateCheckout:false</code> to go live.</div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
    <nav class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-sky-500 flex items-center justify-center text-white font-semibold">LD</div>
        <div class="font-semibold">Laudem Dei Chamber Choir</div>
      </div>
      <div class="hidden sm:flex items-center gap-6 text-sm">
        <a href="#tickets" class="hover:text-sky-700">Tickets</a>
        <a href="#details" class="hover:text-sky-700">Details</a>
        <a href="#faq" class="hover:text-sky-700">FAQ</a>
        <a href="#tickets" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700">Buy Now</a>
      </div>
    </nav>
  </header>

  <!-- Hero -->
  <section class="gradient-hero">
    <div class="max-w-5xl mx-auto px-4 py-14 grid md:grid-cols-2 gap-8 items-center">
      <div>
        <span class="badge inline-block text-xs font-medium px-3 py-1 rounded-full">Live Performance</span>
        <h1 class="mt-4 text-4xl md:text-5xl font-extrabold leading-tight">Spring Serenade Concert</h1>
        <p class="mt-3 text-lg text-slate-600">An evening of choral gems</p>
        <ul class="mt-6 text-slate-700 space-y-1">
          <li>üìç <a id="venueLink" href="#" class="underline decoration-sky-400 underline-offset-4 hover:decoration-sky-600">St. Stithians Chapel</a></li>
          <li>üóìÔ∏è <span id="dateHuman"></span> ‚Ä¢ Doors <span id="doorsHuman"></span></li>
        </ul>
        <div class="mt-6 flex gap-3">
          <a href="#tickets" class="px-5 py-3 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700">Get Tickets</a>
        </div>
      </div>
      <figure class="relative">
        <img id="heroImg" alt="" class="rounded-2xl shadow-xl ring-1 ring-slate-200" />
      </figure>
    </div>
  </section>

  <!-- Tickets -->
  <section id="tickets" class="py-14 bg-white">
    <div class="max-w-5xl mx-auto px-4">
      <h2 class="text-3xl font-bold">Choose your tickets</h2>
      <p class="text-slate-600 mt-2">Secure payments processed by Yoco in ZAR. (Simulated here.)</p>

      <div id="ticketGrid" class="mt-8 grid md:grid-cols-3 gap-6"></div>

      <div class="mt-10 grid md:grid-cols-[1fr,420px] gap-6 items-start">
        <div class="text-sm text-slate-600">
          <h3 class="font-semibold text-slate-800 mb-2">About this concert</h3>
          <p>Experience a night of luminous choral music featuring works by South African and international composers.
             Perfect for families and music lovers of all ages.</p>
          <ul class="mt-4 list-disc ml-5">
            <li>Free parking on site</li>
            <li>Children under 6 enter free (lap seating)</li>
            <li>Doors open 30 minutes before the show</li>
          </ul>
        </div>

        <!-- Order Summary -->
        <aside class="glass rounded-2xl p-6 border border-slate-200 sticky top-20">
          <h3 class="text-xl font-semibold">Your order</h3>
          <div id="orderList" class="mt-4 text-sm text-slate-700 space-y-2">
            <p class="text-slate-500">No tickets selected yet.</p>
          </div>
          <hr class="my-3" />
          <div class="flex items-center justify-between text-lg font-semibold">
            <span>Total</span>
            <span id="total">R0</span>
          </div>
          <button id="payBtn" class="mt-4 w-full px-5 py-3 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700 disabled:opacity-40 disabled:cursor-not-allowed" disabled>Pay with Yoco</button>
          <p class="mt-2 text-xs text-slate-500">You‚Äôll be redirected to secure checkout in live mode; mock checkout opens in test mode.</p>
        </aside>
      </div>
    </div>
  </section>

  <!-- Details -->
  <section id="details" class="py-14 bg-slate-50 border-t border-slate-200">
    <div class="max-w-5xl mx-auto px-4 grid md:grid-cols-3 gap-8">
      <div>
        <h3 class="text-xl font-semibold">When & Where</h3>
        <p class="mt-2">üìç <span id="detailVenue"></span><br><span id="detailAddress"></span></p>
        <p class="mt-2">üóìÔ∏è <span id="detailDate"></span></p>
        <a id="mapsBtn" class="inline-block mt-3 px-4 py-2 rounded-xl border border-slate-300 hover:bg-white" target="_blank">Open in Google Maps</a>
      </div>
      <div>
        <h3 class="text-xl font-semibold">Program Highlights</h3>
        <ul class="mt-2 list-disc ml-5 text-slate-700">
          <li>South African contemporary works</li>
          <li>Classical favourites</li>
          <li>Audience sing‚Äëalong finale</li>
        </ul>
      </div>
      <div>
        <h3 class="text-xl font-semibold">Access</h3>
        <ul class="mt-2 list-disc ml-5 text-slate-700">
          <li>Wheelchair‚Äëfriendly entry</li>
          <li>Assistive ushers available</li>
          <li>Restrooms near entrance</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq" class="py-14">
    <div class="max-w-5xl mx-auto px-4">
      <h3 class="text-2xl font-bold">FAQ</h3>
      <div class="mt-6 grid md:grid-cols-2 gap-6 text-slate-700">
        <div>
          <p class="font-semibold">Will I get an e‚Äëticket?</p>
          <p class="text-sm">Yes. After successful payment, you‚Äôll receive an email with your e‚Äëticket/QR.</p>
        </div>
        <div>
          <p class="font-semibold">Is my card secure?</p>
          <p class="text-sm">Payments are processed by Yoco with 3‚ÄëD Secure and PCI‚ÄëDSS compliance.</p>
        </div>
        <div>
          <p class="font-semibold">Can I get a refund?</p>
          <p class="text-sm">Refunds are available if the event is cancelled or rescheduled. For other cases, email <span class="underline">tickets@laudemdei.org.za</span>.</p>
        </div>
        <div>
          <p class="font-semibold">Need help?</p>
          <p class="text-sm">Email <span class="underline">tickets@laudemdei.org.za</span> and include your order ID.</p>
        </div>
      </div>
    </div>
  </section>

  <footer class="py-8 text-center text-xs text-slate-500 border-t">
    <div class="max-w-5xl mx-auto px-4">¬© <span id="year"></span> <span id="orgFooter"></span>. All rights reserved.</div>
  </footer>

  <!-- Mock Checkout Modal (Test Mode) -->
  <div id="mockModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40" onclick="closeMockCheckout()"></div>
    <div class="relative max-w-lg mx-auto mt-24 bg-white rounded-2xl p-6 shadow-xl border border-slate-200">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Test Checkout (No Payment)</h3>
        <button class="text-slate-500 hover:text-slate-700" onclick="closeMockCheckout()">‚úï</button>
      </div>
      <p class="mt-1 text-sm text-slate-600">This simulates a successful Yoco payment for testing the flow.</p>
      <form id="mockForm" class="mt-4 grid gap-3">
        <div>
          <label class="text-sm text-slate-600">Buyer name</label>
          <input id="buyerName" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g., Thandi Ndlovu" required />
        </div>
        <div>
          <label class="text-sm text-slate-600">Email for e‚Äëtickets</label>
          <input id="buyerEmail" type="email" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="you@example.com" required />
        </div>
        <div>
          <label class="text-sm text-slate-600">Cell number <span class="text-slate-400">(country code) number</span></label>
          <input id="buyerCell" type="tel" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="(+27) 82 123 4567" required />
          <p class="text-[11px] text-slate-500 mt-1">Format examples: <code>(+27) 82 123 4567</code>, <code>(+44) 7123 456789</code></p>
        </div>
        <div id="mockSummary" class="text-sm text-slate-700 bg-slate-50 border border-slate-200 rounded-xl p-3"></div>
        <div class="mt-2 flex items-center justify-between">
          <button type="button" class="px-4 py-2 rounded-xl border" onclick="closeMockCheckout()">Back</button>
          <button id="mockPayBtn" type="submit" class="px-5 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700">Confirm Payment</button>
        </div>
      </form>
      <div id="mockSuccess" class="hidden mt-4">
        <div class="rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-900">
          <p class="font-semibold">Payment Successful (Simulated)</p>
          <p class="text-sm">Order <span id="mockOrder"></span> ‚Äî Your tickets are below with QR codes.</p>
        </div>
        <div id="mockTickets" class="mt-3 text-sm"></div>
        <div class="mt-4 flex gap-2 justify-end">
          <button id="pngBtn" class="px-5 py-2 rounded-xl bg-slate-700 text-white font-semibold hover:opacity-90">Download PNG Tickets</button>
          <button id="pdfBtn" class="px-5 py-2 rounded-xl bg-slate-800 text-white font-semibold hover:opacity-90">Download PDF Tickets</button>
          <button class="px-5 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700" onclick="closeMockCheckout()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error banner -->
  <div id="errBanner" class="hidden fixed bottom-3 right-3 z-50 max-w-md bg-red-50 text-red-900 border border-red-200 rounded-xl shadow p-3 text-sm"></div>

  <script>
    // ===== Utilities =====
    const ZAR = new Intl.NumberFormat('en-ZA', { style:'currency', currency:'ZAR', maximumFractionDigits:0 });
    const fmt = (cents) => ZAR.format(cents/100);
    const qs = (s,r) => (r||document).querySelector(s);
    const qsa = (s,r) => Array.from((r||document).querySelectorAll(s));
    const toHuman = (iso) => new Intl.DateTimeFormat(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}).format(new Date(iso));

    // ===== SA mobile format/validate (auto on blur) =====
    function saDigits(s){ return (s||'').replace(/[^0-9]+/g,''); }
    function saNormalizeNSN(raw){
      const d = saDigits(raw);
      if (!d) return null;
      let nsn = d;
      if (d.startsWith('27')) nsn = d.slice(2);   // strip +27 / 27
      else if (d.startsWith('0')) nsn = d.slice(1); // strip leading 0
      if (nsn.length !== 9) return null;          // SA NSN is 9 digits
      if (!/[678]/.test(nsn[0])) return null;     // mobiles start 6/7/8
      return nsn;
    }
    function saFormatInternational(raw){
      const nsn = saNormalizeNSN(raw);
      if (!nsn) return null;
      return '(+27) ' + nsn.slice(0,2) + ' ' + nsn.slice(2,5) + ' ' + nsn.slice(5);
    }

    // ===== Render Header & Details =====
    function renderHeader(){
      qs('#venueLink').href = CONFIG.event.mapLink;
      qs('#dateHuman').textContent = toHuman(CONFIG.event.dateISO);
      qs('#doorsHuman').textContent = new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(new Date(CONFIG.event.doorsISO));
      const img = qs('#heroImg'); img.src = CONFIG.event.heroImg; img.alt = CONFIG.event.heroAlt || 'Event image';
      qs('#detailVenue').textContent = CONFIG.event.venue;
      qs('#detailAddress').textContent = CONFIG.event.address;
      qs('#detailDate').textContent = toHuman(CONFIG.event.dateISO);
      qs('#mapsBtn').href = CONFIG.event.mapLink;
      qs('#year').textContent = new Date().getFullYear();
      qs('#orgFooter').textContent = CONFIG.orgName;
    }

    // ===== Tickets & Cart =====
    const cart = new Map();
    function renderTickets(){
      const grid = qs('#ticketGrid'); grid.innerHTML='';
      CONFIG.tickets.forEach(t=>{
        const card = document.createElement('div');
        card.className = 'ticket-card rounded-2xl border border-slate-200 p-6 transition-all';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <h4 class="text-lg font-semibold">${t.name}</h4>
            <div class="text-xl font-bold">${fmt(t.price)}</div>
          </div>
          <p class="mt-1 text-sm text-slate-600">${t.desc||''}</p>
          <div class="mt-4 flex items-center gap-2">
            <button data-code="${t.code}" class="qtyDown px-3 py-2 rounded-lg border">‚àí</button>
            <input data-code="${t.code}" type="number" min="0" max="${t.limit||99}" value="0" class="qtyInput w-16 text-center border rounded-lg py-2" />
            <button data-code="${t.code}" class="qtyUp px-3 py-2 rounded-lg border">+</button>
          </div>`;
        grid.appendChild(card);
      });
      qsa('.qtyUp').forEach(btn=>btn.addEventListener('click',()=>changeQty(btn.dataset.code,1)));
      qsa('.qtyDown').forEach(btn=>btn.addEventListener('click',()=>changeQty(btn.dataset.code,-1)));
      qsa('.qtyInput').forEach(inp=>inp.addEventListener('input',()=>setQty(inp.dataset.code,parseInt(inp.value||'0',10))));
    }
    function setQty(code, qty){
      const t = CONFIG.tickets.find(x=>x.code===code);
      const clamp = Math.max(0, Math.min(qty||0, t.limit||99));
      if (clamp===0) cart.delete(code); else cart.set(code, clamp);
      qsa(`.qtyInput[data-code="${code}"]`).forEach(i=>i.value=clamp);
      renderOrder();
    }
    function changeQty(code, d){ setQty(code, (cart.get(code)||0)+d); }
    function totals(){ let total=0; cart.forEach((qty,code)=>{ const t=CONFIG.tickets.find(x=>x.code===code); total += t.price*qty; }); return { total }; }
    function renderOrder(){
      const list = qs('#orderList'); list.innerHTML='';
      if (cart.size===0) list.innerHTML = '<p class="text-slate-500">No tickets selected yet.</p>';
      else cart.forEach((qty,code)=>{ const t=CONFIG.tickets.find(x=>x.code===code); const row=document.createElement('div'); row.className='flex items-center justify-between'; row.innerHTML=`<span class="text-sm">${t.name} √ó ${qty}</span><span class="text-sm font-medium">${fmt(t.price*qty)}</span>`; list.appendChild(row); });
      const { total } = totals(); qs('#total').textContent = fmt(total); qs('#payBtn').disabled = !(total>0);
    }

    // ===== Mock Checkout =====
    function openMockCheckout(items, total){
      const modal = qs('#mockModal'); const sum = qs('#mockSummary');
      const lines = items.map(it=>{ const t=CONFIG.tickets.find(x=>x.code===it.code); return `<div class="flex justify-between"><span>${t.name} √ó ${it.qty}</span><span>${fmt(t.price*it.qty)}</span></div>`; }).join('');
      sum.innerHTML = lines + '<hr class="my-2"/>' + `<div class='flex justify-between font-semibold'><span>Total</span><span>${fmt(total)}</span></div>`;
      qs('#mockForm').onsubmit = function(e){ e.preventDefault(); confirmMockPayment(items, total); };
      qs('#mockSuccess').classList.add('hidden'); qs('#mockForm').classList.remove('hidden'); modal.classList.remove('hidden');
    }
    function closeMockCheckout(){ const m=qs('#mockModal'); if(m) m.classList.add('hidden'); }
    function randomId(prefix){ return (prefix||'ord_') + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4); }
    function confirmMockPayment(items, total){
      const name  = qs('#buyerName').value.trim();
      const email = qs('#buyerEmail').value.trim();
      let cellRaw = qs('#buyerCell').value.trim();
      const cellFmt = saFormatInternational(cellRaw);
      if(!name){ alert('Please enter your full name.'); return; }
      if(!(email.includes('@') && email.includes('.'))){ alert('Please enter a valid email address.'); return; }
      if(!cellFmt){ alert('Please enter a South African mobile like (+27) 82 123 4567'); return; }
      // Write back normalized value so UI shows the proper format
      qs('#buyerCell').value = cellFmt;
      const orderId = randomId('order_'); const ticketsDiv = qs('#mockTickets'); ticketsDiv.innerHTML='';
      const generated = [];
      items.forEach(it=>{ const t = CONFIG.tickets.find(x=>x.code===it.code); for(let i=1;i<=it.qty;i++){
        const tkt=randomId('TKT-');
        const row=document.createElement('div');
        row.className='grid grid-cols-[1fr,120px,120px] gap-3 border border-slate-200 rounded-lg px-3 py-2 mt-2 items-center';
        row.innerHTML = `<div><div class='font-medium'>${t.name}</div><div class='text-xs text-slate-500'>${tkt}</div><div class='text-xs'>${fmt(t.price)}</div><div class='text-xs text-slate-600 mt-1'>${toHuman(CONFIG.event.dateISO)} ‚Ä¢ ${CONFIG.event.venue}</div><div class='text-[11px] text-slate-500'>${CONFIG.event.address}</div></div><div id='qr_${tkt}' class='justify-self-end'></div><div id='mapqr_${tkt}' class='justify-self-end'></div>`;
        ticketsDiv.appendChild(row);
        row.setAttribute('data-ticket-id', tkt);
        const qrDiv = row.querySelector('#qr_'+tkt);
        const mapDiv = row.querySelector('#mapqr_'+tkt);
        const payload = JSON.stringify({ order: orderId, ticket: tkt, event: CONFIG.event.id, title: CONFIG.event.title, dateISO: CONFIG.event.dateISO, venue: CONFIG.event.venue, address: CONFIG.event.address, name: name, email: email, cell: cellFmt });
        new QRCode(qrDiv, { text: payload, width:110, height:110, correctLevel: QRCode.CorrectLevel.M });
        // Map QR leads to venue map link
        new QRCode(mapDiv, { text: CONFIG.event.mapLink, width:110, height:110, correctLevel: QRCode.CorrectLevel.M });
        setTimeout(()=>{ const img1 = qrDiv.querySelector('img') || qrDiv.querySelector('canvas'); let dataUrl1=''; if (img1 && img1.tagName==='IMG') dataUrl1 = img1.src; else if (img1 && img1.toDataURL) dataUrl1 = img1.toDataURL('image/png'); const img2 = mapDiv.querySelector('img') || mapDiv.querySelector('canvas'); let dataUrl2=''; if (img2 && img2.tagName==='IMG') dataUrl2 = img2.src; else if (img2 && img2.toDataURL) dataUrl2 = img2.toDataURL('image/png'); generated.push({ code:t.code, name:t.name, ticket_id:tkt, price_cents:t.price, qr_png:dataUrl1, map_qr_png:dataUrl2 }); }, 40);
      } });
      qs('#mockOrder').textContent = orderId; qs('#mockForm').classList.add('hidden'); qs('#mockSuccess').classList.remove('hidden');
      const pdfBtn = qs('#pdfBtn'); pdfBtn.onclick = async function(){ const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'}); const container=document.createElement('div'); container.style.width='820px'; container.style.padding='20px'; container.style.fontFamily='Inter, Arial, sans-serif'; container.innerHTML = `<h2 style=\"margin:0 0 8px 0\">${CONFIG.orgName} ‚Äî ${CONFIG.event.title}</h2><div style=\"font-size:12px;color:#334155\">Order ${orderId}</div><div style=\"margin:8px 0 12px 0;font-size:12px;color:#334155\"><div><strong>Date:</strong> ${toHuman(CONFIG.event.dateISO)}</div><div><strong>Venue:</strong> ${CONFIG.event.venue}</div><div><strong>Address:</strong> ${CONFIG.event.address}</div><div><strong>Map:</strong> <a href='${CONFIG.event.mapLink}'>${CONFIG.event.mapLink}</a></div></div>`; generated.forEach(t=>{ const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr 120px 120px'; row.style.gap='12px'; row.style.alignItems='center'; row.style.border='1px solid #e2e8f0'; row.style.borderRadius='12px'; row.style.padding='10px 14px'; row.style.marginTop='10px'; row.innerHTML = `<div><div style='font-weight:600'>${t.name}</div><div style='font-size:12px;color:#64748b'>${t.ticket_id}</div></div>`; const img=document.createElement('img'); img.src=t.qr_png; img.style.width='110px'; img.style.height='110px'; img.style.objectFit='contain'; const mapimg=document.createElement('img'); mapimg.src=t.map_qr_png; mapimg.style.width='110px'; mapimg.style.height='110px'; mapimg.style.objectFit='contain'; row.appendChild(img); row.appendChild(mapimg); container.appendChild(row); }); document.body.appendChild(container); const canvas = await html2canvas(container); document.body.removeChild(container); const imgData=canvas.toDataURL('image/png'); const pageWidth=doc.internal.pageSize.getWidth(); const ratio=canvas.height/canvas.width; doc.addImage(imgData,'PNG',20,20,pageWidth-40,(pageWidth-40)*ratio); doc.save(`${CONFIG.event.id}_${orderId}_tickets.pdf`); };
      // PNG export per ticket
      const pngBtn = qs('#pngBtn');
      if (pngBtn) { pngBtn.onclick = async function(){
        const rows = qsa('#mockTickets > div');
        if (!rows.length) { alert('No tickets to export.'); return; }
        for (const row of rows) {
          // Save previous inline styles to restore later
          const prev = {
            backgroundColor: row.style.backgroundColor,
            borderRadius: row.style.borderRadius,
            border: row.style.border,
            boxShadow: row.style.boxShadow,
            overflow: row.style.overflow,
            padding: row.style.padding
          };
          // Style for prettier PNG with rounded corners
          row.style.backgroundColor = '#ffffff';
          row.style.borderRadius = '16px';
          row.style.border = '2px solid #e2e8f0';
          row.style.boxShadow = '0 8px 20px rgba(2,132,199,0.08)';
          row.style.overflow = 'hidden';
          row.style.padding = row.style.padding || '12px 16px';

          const canvas = await html2canvas(row, { backgroundColor: null, scale: 2 });

          // Restore previous styles
          row.style.backgroundColor = prev.backgroundColor;
          row.style.borderRadius = prev.borderRadius;
          row.style.border = prev.border;
          row.style.boxShadow = prev.boxShadow;
          row.style.overflow = prev.overflow;
          row.style.padding = prev.padding;

          const dataUrl = canvas.toDataURL('image/png');
          const a = document.createElement('a');
          const tid = row.dataset.ticketId || 'ticket';
          a.href = dataUrl; a.download = `${CONFIG.event.id}_${tid}.png`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          await new Promise(r=>setTimeout(r,120));
        }
      }; }
    }

    // ===== Boot =====
    function boot(){
      try {
        renderHeader(); renderTickets(); renderOrder();
        // Auto-format SA cell number after losing focus
        (function(){
          const cellEl = qs('#buyerCell');
          if (!cellEl) return;
          const run = ()=>{
            const f = saFormatInternational(cellEl.value);
            if (f) { cellEl.setCustomValidity(''); cellEl.value = f; }
            else { cellEl.setCustomValidity('Enter a South African mobile like (+27) 82 123 4567'); }
          };
          cellEl.addEventListener('blur', run);    // on losing focus
          cellEl.addEventListener('change', run);  // if value changed
          cellEl.addEventListener('input', ()=>cellEl.setCustomValidity(''));
        })();
        qs('#payBtn').addEventListener('click', function(){
          const items = Array.from(cart.entries()).map(([code,qty])=>({code,qty}));
          const { total } = totals();
          if (total<=0) { alert('Please select at least one ticket.'); return; }
          if (CONFIG.simulateCheckout) { openMockCheckout(items, total); return; }
          // Live modes
          if (CONFIG.yoco.mode === 'payment_link') {
            if (items.length !== 1) { alert('Multiple ticket types selected. Use one type or switch to checkout mode.'); return; }
            const link = CONFIG.yoco.paymentLinks[items[0].code]; if (!link || link==='#') { alert('No Yoco link configured for this ticket.'); return; }
            window.location.href = link; return;
          }
          alert('Hosted checkout not configured in this test build.');
        });
      } catch(e){ const b = qs('#errBanner'); if (b){ b.textContent = e.message || 'Script error'; b.classList.remove('hidden'); } console.error(e); }
    }
    document.addEventListener('DOMContentLoaded', boot);

    window.addEventListener('error', function(e){ const b=qs('#errBanner'); if (!b) return; b.textContent=(e.message||'Script error') + (e.filename? (' @ '+e.filename+':'+e.lineno):''); b.classList.remove('hidden'); });
  </script>
</body>
</html>
