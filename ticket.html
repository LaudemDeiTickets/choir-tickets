
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ticket</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    html,body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f8fafc; }
    .ticket { background:#fff; border-radius:18px; border:1px solid #e2e8f0; box-shadow:0 12px 40px rgba(2,132,199,.08); overflow:hidden; }
    .notch { background: radial-gradient(circle at 0 50%, transparent 14px, #fff 15px) left,
             radial-gradient(circle at 100% 50%, transparent 14px, #fff 15px) right;
             background-size:50% 100%; background-repeat:no-repeat; }
  </style>
</head>
<body class="p-4 sm:p-8">
  <div class="max-w-3xl mx-auto">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-xl font-bold">Your Ticket</h1>
      <div class="flex gap-2">
        <button id="btnOpen" class="px-3 py-2 rounded-lg border">Open in new window</button>
        <button id="btnPng" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Download PNG</button>
      </div>
    </header>

    <section id="ticket" class="ticket">
      <div class="p-5 flex items-start gap-4">
        <img id="logo" class="w-12 h-12 rounded-xl ring-1 ring-slate-200 object-contain bg-white" alt="Logo">
        <div class="flex-1">
          <div class="text-lg font-semibold" id="title">Event Title</div>
          <div class="text-sm text-slate-600" id="subtitle">Event subtitle</div>
          <div class="text-sm mt-2">
            <span id="when">Sat, 11 Oct 2025 • 18:30</span> • <span id="venue">Venue name</span>
          </div>
          <div class="text-xs text-slate-500" id="address">Address line</div>
          <div class="mt-2 text-xs text-slate-500">Buyer: <span id="buyer"></span></div>
        </div>
        <div id="qr" class="w-[110px] h-[110px] shrink-0"></div>
      </div>
      <div class="notch h-12 border-t border-dashed border-slate-300"></div>
      <div class="p-5 grid sm:grid-cols-3 gap-4 text-sm">
        <div>
          <div class="text-slate-500 text-xs">Ticket ID</div>
          <div class="font-mono font-semibold" id="ticketId">TKT-XXXXXX</div>
        </div>
        <div>
          <div class="text-slate-500 text-xs">Type</div>
          <div id="ticketName">General Admission</div>
        </div>
        <div>
          <div class="text-slate-500 text-xs">Price</div>
          <div id="ticketPrice">R0</div>
        </div>
      </div>
    </section>

    <form id="emailForm" class="mt-6 grid sm:grid-cols-[1fr_auto] gap-3">
      <input id="emailTo" type="email" placeholder="Email this ticket to…" class="border rounded-lg px-3 py-2" required>
      <button class="px-4 py-2 rounded-lg bg-sky-600 text-white">Send</button>
      <div id="sendMsg" class="text-sm text-slate-600 col-span-full"></div>
    </form>
  </div>

<script>
(function(){
  'use strict';

  const params = new URLSearchParams(location.search);
  const data = {
    logo: params.get('logo') || 'https://laudemdeitickets.github.io/choir-tickets/logo.jpeg',
    title: params.get('title') || 'Spring Serenade Concert',
    subtitle: params.get('subtitle') || 'An evening of choral gems',
    when: params.get('when') || 'Sat, 11 Oct 2025 • 18:30',
    venue: params.get('venue') || 'St. Stithians Chapel',
    address: params.get('address') || '40 Peter Place, Lyme Park, Sandton, 2191',
    buyer: params.get('buyer') || 'Thandi Ndlovu • (+27) 82 123 4567',
    ticketId: params.get('ticketId') || ('TKT-' + Math.random().toString(36).slice(2,8)),
    ticketName: params.get('ticketName') || 'General Admission',
    price: params.get('price') || 'R200'
  };

  document.getElementById('logo').src = data.logo;
  document.getElementById('title').textContent = data.title;
  document.getElementById('subtitle').textContent = data.subtitle;
  document.getElementById('when').textContent = data.when;
  document.getElementById('venue').textContent = data.venue;
  document.getElementById('address').textContent = data.address;
  document.getElementById('buyer').textContent = data.buyer;
  document.getElementById('ticketId').textContent = data.ticketId;
  document.getElementById('ticketName').textContent = data.ticketName;
  document.getElementById('ticketPrice').textContent = data.price;

  const payload = JSON.stringify({
    ticket: data.ticketId, title: data.title, when: data.when, venue: data.venue, buyer: data.buyer
  });
  new QRCode(document.getElementById('qr'), { text: payload, width:110, height:110, correctLevel: QRCode.CorrectLevel.M });

  document.getElementById('btnOpen').onclick = function(){
    const url = location.pathname + "?" + params.toString();
    window.open(url, "_blank");
  };

  document.getElementById('btnPng').onclick = async function(){
    const el = document.getElementById('ticket');
    const prevBg = el.style.backgroundColor;
    el.style.backgroundColor = "#ffffff";
    const canvas = await html2canvas(el, { backgroundColor: null, scale: 2, useCORS:true });
    el.style.backgroundColor = prevBg;
    const dataUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataUrl; a.download = `${data.ticketId}.png`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  document.getElementById('emailForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const to = document.getElementById('emailTo').value.trim();
    const msg = document.getElementById('sendMsg');
    msg.textContent = 'Rendering ticket…';

    const el = document.getElementById('ticket');
    const prevBg = el.style.backgroundColor;
    el.style.backgroundColor = "#ffffff";
    const canvas = await html2canvas(el, { backgroundColor: null, scale: 2, useCORS:true });
    el.style.backgroundColor = prevBg;
    const dataUrl = canvas.toDataURL('image/png');

    msg.textContent = 'Sending email…';
    try{
      const r = await fetch('/api/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          to,
          subject: `${data.title} — ${data.ticketName}`,
          html: `<p>Here is your ticket for <strong>${data.title}</strong> (${data.ticketName}).</p>`,
          text: `Your ticket for ${data.title} (${data.ticketName}).`,
          imageDataUrl: dataUrl,
          filename: `${data.ticketId}.png`
        })
      });
      const p = await r.json();
      if (!p.ok) throw new Error(p.error || 'Send failed');
      msg.textContent = 'Email sent ✅';
    }catch(err){
      console.error(err);
      msg.textContent = 'Send failed: ' + (err.message||'');
    }
  });

})();
</script>
</body>
</html>
