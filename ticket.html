<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Tickets</title>
  <meta name="robots" content="noindex">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .glass { background: rgba(255,255,255,.72); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-white text-slate-800">
  <div class="max-w-3xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- Cache-busted logo -->
        <img id="orgLogo" src="https://laudemdeitickets.github.io/choir-tickets/logo.jpeg?v=5"
             alt="Logo" class="w-12 h-12 rounded-xl ring-1 ring-slate-200 object-contain bg-white"
             crossorigin="anonymous" referrerpolicy="no-referrer">
        <div>
          <h1 class="text-xl font-bold">Your Tickets</h1>
          <p class="text-sm text-slate-500">Save or share your tickets below</p>
        </div>
      </div>
      <a href="index.html" class="text-sm underline hover:no-underline">Back to tickets</a>
    </header>

    <!-- Error banner -->
    <div id="errBox" class="hidden mt-4 rounded-xl border border-red-200 bg-red-50 text-red-900 p-3 text-sm"></div>

    <!-- Event summary -->
    <section id="eventBox" class="mt-6 glass rounded-2xl border border-slate-200 p-5 hidden">
      <h2 id="evTitle" class="text-lg font-semibold"></h2>
      <p id="evMeta" class="text-sm text-slate-600"></p>
      <p id="evAddr" class="text-sm text-slate-700"></p>
    </section>

    <!-- Tickets -->
    <section id="successWrap" class="hidden mt-6">
      <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-900">
        <p class="font-semibold">Tickets ready</p>
        <p class="text-sm">Order <span id="orderIdOut"></span> â€” Download or share your ticket(s).</p>
      </div>
      <div id="ticketsWrap" class="mt-3 text-sm"></div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="pngBtn" class="px-5 py-3 rounded-xl bg-slate-800 text-white font-semibold hover:opacity-90" type="button">Download PNG</button>
        <button id="shareAllBtn" class="px-5 py-3 rounded-xl border hover:bg-white" type="button">Share all</button>
        <a id="whatsFallback" class="px-5 py-3 rounded-xl border hover:bg-white hidden" target="_blank" rel="noopener">Open WhatsApp</a>
        <button id="doneBtn" class="px-5 py-3 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700" type="button">Done</button>
      </div>
      <p id="shareHint" class="text-xs text-slate-500 mt-2"></p>
    </section>
  </div>

  <script>
  (function(){
    'use strict';

    // ===== helpers =====
    const qs = (s,r)=> (r||document).querySelector(s);
    const qsa = (s,r)=> Array.from((r||document).querySelectorAll(s));
    const toHuman = (iso)=> iso ? new Intl.DateTimeFormat(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}).format(new Date(iso)) : '';
    function showError(msg){ const b=qs('#errBox'); b.textContent=msg||'Error'; b.classList.remove('hidden'); }
    function onlyDigits(s){ return String(s||'').replace(/[^0-9]+/g,''); }
    function toWhatsAppNum(input){ const d=onlyDigits(input); if(!d) return ''; if(d.startsWith('27')) return d; if(d.startsWith('0')) return '27'+d.slice(1); return d; }

    // ===== verify token on server =====
    async function loadFromToken(){
      const params = new URLSearchParams(location.search);
      const token = params.get('token') || params.get('t');
      if (!token){ showError('Missing token'); return null; }

      try{
        const resp = await fetch('https://choir-tickets.vercel.app/api/tickets/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data?.error || ('verify '+resp.status));
        return { token, payload: data };
      } catch(e){
        console.error(e);
        showError('Could not verify ticket link. ' + (e.message||''));
        return null;
      }
    }

    // ===== render tickets =====
    function renderTickets({ payload }){
      const wrap = qs('#ticketsWrap'); wrap.innerHTML = '';
      const ev = payload.event || {};
      const buyer = payload.buyer || {};
      const items = Array.isArray(payload.items) ? payload.items : [];

      // Header summary (now includes full address)
      qs('#orderIdOut').textContent = payload.orderId || 'â€”';
      qs('#evTitle').textContent = ev.title || 'Event';
      qs('#evMeta').textContent = [toHuman(ev.startISO), ev.venue].filter(Boolean).join(' â€¢ ');
      qs('#evAddr').textContent = ev.address || '';
      qs('#eventBox').classList.remove('hidden');

      // Force-refresh the logo everywhere (header + tickets)
      const logoUrl = (payload.orgLogo || 'https://laudemdeitickets.github.io/choir-tickets/logo.jpeg') + '?v=5';
      const headerLogo = qs('#orgLogo'); if (headerLogo) headerLogo.src = logoUrl;

      // Build each ticket card (event + address printed on the ticket)
      for (const it of items){
        const qty = Math.max(1, Number(it.qty||1));
        for (let i=0; i<qty; i++){
          const tkt = 'TKT-' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4);
          const row = document.createElement('div');
          row.className = 'grid grid-cols-[1fr,120px] gap-4 border border-slate-200 rounded-xl px-4 py-4 mt-3 items-center';
          row.setAttribute('data-ticket-id', tkt);
          row.innerHTML = `
            <div>
              <div class='flex items-center gap-3'>
                <img src='${logoUrl}' crossorigin='anonymous' referrerpolicy='no-referrer'
                     class='w-9 h-9 rounded-md ring-1 ring-slate-200 object-contain bg-white' alt='logo' />
                <div>
                  <div class='text-base font-semibold'>${ev.title || 'Event'}</div>
                  <div class='text-[12px] text-slate-500'>${it.name || 'Admission'} â€¢ Ticket ID: ${tkt}</div>
                </div>
              </div>

              <div class='mt-2 text-[13px]'>
                <div class='text-slate-700'><span class='font-medium'>When:</span> ${toHuman(ev.startISO) || 'â€”'}</div>
                <div class='text-slate-700'><span class='font-medium'>Where:</span> ${ev.venue || 'â€”'}</div>
                <div class='text-slate-500 text-[12px]'>${ev.address || ''}</div>
              </div>

              <div class='mt-2 text-[12px] text-slate-500'>
                Buyer: ${(buyer.firstName||'')} ${(buyer.lastName||'')} â€¢ ${(buyer.cell||'')}
              </div>
            </div>
            <div id='qr_${tkt}' class='justify-self-end'></div>
          `;
          wrap.appendChild(row);

          // QR payload
          const qrDiv = row.querySelector('#qr_'+tkt);
          const payloadForQR = {
            order: payload.orderId, ticket: tkt,
            event: ev.id, title: ev.title,
            dateISO: ev.startISO, venue: ev.venue, address: ev.address,
            firstName: buyer.firstName, lastName: buyer.lastName, email: buyer.email, cell: buyer.cell
          };
          new QRCode(qrDiv, { text: JSON.stringify(payloadForQR), width:120, height:120, correctLevel: QRCode.CorrectLevel.M });
        }
      }

      qs('#successWrap').classList.remove('hidden');
      qs('#shareHint').textContent = 'Tip: On Windows/Edge the native Share panel lets you send PNGs to WhatsApp, Outlook, etc.';
    }

    // ===== capture all ticket cards as PNG Files =====
    async function captureTicketPNGs(){
      const rows = qsa('#ticketsWrap > div');
      const files = [];
      let i=0;
      for (const row of rows){
        // beautify for export
        const prev = { backgroundColor: row.style.backgroundColor, borderRadius: row.style.borderRadius, border: row.style.border, boxShadow: row.style.boxShadow, overflow: row.style.overflow, padding: row.style.padding };
        row.style.backgroundColor = '#ffffff';
        row.style.borderRadius = '16px';
        row.style.border = '2px solid #e2e8f0';
        row.style.boxShadow = '0 8px 20px rgba(2,132,199,0.08)';
        row.style.overflow = 'hidden';
        row.style.padding = row.style.padding || '12px 16px';

        const canvas = await html2canvas(row, { backgroundColor:'#ffffff', scale:2, useCORS:true });

        // revert
        row.style.backgroundColor = prev.backgroundColor;
        row.style.borderRadius = prev.borderRadius;
        row.style.border = prev.border;
        row.style.boxShadow = prev.boxShadow;
        row.style.overflow = prev.overflow;
        row.style.padding = prev.padding;

        const blob = await new Promise(res=> canvas.toBlob(b=>res(b), 'image/png'));
        if (!blob) continue;
        const tid = row.dataset.ticketId || `ticket_${++i}`;
        files.push(new File([blob], `choir-ticket_${tid}.png`, { type:'image/png' }));
        if (files.length >= 10) break; // practical limit
      }
      return files;
    }

    // ===== wire buttons =====
    function wireActions(ctx){
      const buyer = ctx?.payload?.buyer || {};
      const ev = ctx?.payload?.event || {};
      const dlBtn = qs('#pngBtn');
      const shareBtn = qs('#shareAllBtn');
      const waFallback = qs('#whatsFallback');

      dlBtn.onclick = async function(){
        const files = await captureTicketPNGs();
        if (!files.length) { alert('No tickets to export.'); return; }
        for (const f of files){
          const a = document.createElement('a');
          a.href = URL.createObjectURL(f);
          a.download = f.name;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          await new Promise(r=>setTimeout(r,120));
        }
      };

      shareBtn.onclick = async function(){
        try{
          const files = await captureTicketPNGs();
          if (!files.length) { alert('No tickets to share.'); return; }

          // Native share sheet with files (Windows/Edge/Chrome)
          if (navigator.canShare && navigator.canShare({ files })){
            await navigator.share({
              files,
              title: ev?.title || 'Your tickets',
              text: 'Your tickets are attached.'
            });
            return;
          }

          // Fallback: WhatsApp with claim link
          const params = new URLSearchParams(location.search);
          const token = params.get('token') || '';
          const claimUrl = token ? `${location.origin}${location.pathname}?paid=1&token=${encodeURIComponent(token)}` : location.href;
          const text = `ðŸŽŸï¸ ${ev?.title || 'Your tickets'}\nOrder ${ctx?.payload?.orderId || ''}\n${claimUrl}`;
          const waNum = toWhatsAppNum(buyer?.cell || '');
          const wurl = waNum ? `https://wa.me/${waNum}?text=${encodeURIComponent(text)}`
                             : `https://wa.me/?text=${encodeURIComponent(text)}`;
          waFallback.href = wurl;
          waFallback.classList.remove('hidden');
          waFallback.click();
        } catch(e){
          console.error(e);
          alert('Sharing not supported on this device. Weâ€™ll download PNGs so you can share manually.');
          dlBtn.click();
        }
      };

      qs('#doneBtn').onclick = ()=> window.location.href = 'index.html';
    }

    // ===== boot =====
    (async function boot(){
      const ctx = await loadFromToken();
      if (!ctx) return;
      renderTickets(ctx);
      wireActions(ctx);
    })();
  })();
  </script>
</body>
</html>
