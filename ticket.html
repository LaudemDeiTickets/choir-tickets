<button id="shareAllBtn" class="btn">Share all</button>
<script>
(async function(){
  const qs = (s,r)=> (r||document).querySelector(s);
  const qsa = (s,r)=> Array.from((r||document).querySelectorAll(s));

  // Optional: if you have the buyer‚Äôs SA number, use it for WhatsApp fallback
  function onlyDigits(s){ return String(s||"").replace(/[^0-9]+/g,""); }
  function toWhatsAppNum(input){
    const d = onlyDigits(input||""); if (!d) return "";
    if (d.startsWith("27")) return d;
    if (d.startsWith("0")) return "27" + d.slice(1);
    return d;
  }

  async function captureTicketPNGs() {
    const rows = qsa('#ticketsWrap > div'); // your ticket cards container
    const files = [];
    let i = 0;
    for (const row of rows){
      // Make it look nice in the PNG (optional style tweaks)
      const prev = {
        backgroundColor: row.style.backgroundColor,
        borderRadius: row.style.borderRadius,
        border: row.style.border,
        boxShadow: row.style.boxShadow,
        overflow: row.style.overflow,
        padding: row.style.padding
      };
      row.style.backgroundColor = '#ffffff';
      row.style.borderRadius = '16px';
      row.style.border = '2px solid #e2e8f0';
      row.style.boxShadow = '0 8px 20px rgba(2,132,199,0.08)';
      row.style.overflow = 'hidden';
      row.style.padding = row.style.padding || '12px 16px';

      const canvas = await html2canvas(row, { backgroundColor:'#ffffff', scale:2, useCORS:true });

      // Revert styles
      row.style.backgroundColor = prev.backgroundColor;
      row.style.borderRadius = prev.borderRadius;
      row.style.border = prev.border;
      row.style.boxShadow = prev.boxShadow;
      row.style.overflow = prev.overflow;
      row.style.padding = prev.padding;

      const blob = await new Promise(res => canvas.toBlob(b => res(b), 'image/png'));
      if (!blob) continue;
      const tid = row.dataset.ticketId || `ticket_${++i}`;
      files.push(new File([blob], `${document.title || 'ticket'}_${tid}.png`, { type:'image/png' }));
      if (files.length >= 10) break; // practical limit for share sheets
    }
    return files;
  }

  async function shareAll() {
    try {
      const files = await captureTicketPNGs();
      if (!files.length) { alert('No tickets to share.'); return; }

      // Try native share with files (shows Windows share sheet)
      if (navigator.canShare && navigator.canShare({ files })) {
        await navigator.share({
          files,
          title: document.title || 'Your tickets',
          text: 'Your tickets are attached.'
        });
        return;
      }

      // Fallback 1: open WhatsApp with a claim link (no file attach via wa.me)
      // If you‚Äôve got the buyer‚Äôs cell on this page, use it; else it will open a generic composer
      const buyerCell = qs('#buyerCell')?.value || ''; // or inject from JWT
      const waNum = toWhatsAppNum(buyerCell);
      const params = new URLSearchParams(location.search);
      const token = params.get('token') || '';
      const claimBase = 'ticket.html'; // or your CLAIM_BASE_URL page if different
      const claimUrl = token ? `${claimBase}?paid=1&token=${encodeURIComponent(token)}` : location.href;
      const msg = `üéüÔ∏è Your tickets\n${claimUrl}`;
      const wurl = waNum ? `https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`
                         : `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(wurl, '_blank');

    } catch (e) {
      console.error(e);
      // Fallback 2: save PNGs, and let them share manually
      const files = await captureTicketPNGs();
      for (const f of files){
        const a = document.createElement('a');
        a.href = URL.createObjectURL(f);
        a.download = f.name;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      }
      alert('Your device does not support native sharing from the browser. PNGs have been downloaded.');
    }
  }

  qs('#shareAllBtn')?.addEventListener('click', shareAll);
})();
</script>
