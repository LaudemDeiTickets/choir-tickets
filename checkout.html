<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout ‚Äî Laudem Dei Chamber Choir</title>
  <meta name="description" content="Checkout for Laudem Dei Chamber Choir tickets." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .glass { background: rgba(255,255,255,.72); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-white text-slate-800">
  <div class="max-w-3xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://laudemdeitickets.github.io/choir-tickets/logo.jpeg" alt="Logo" class="w-12 h-12 rounded-xl ring-1 ring-slate-200 object-contain bg-white">
        <div>
          <h1 class="text-xl font-bold">Laudem Dei Chamber Choir</h1>
          <p class="text-sm text-slate-500">Secure checkout</p>
        </div>
      </div>
      <a href="index.html" class="text-sm underline hover:no-underline">Back to tickets</a>
    </header>

    <section class="mt-6 glass rounded-2xl border border-slate-200 p-5">
      <h2 class="text-lg font-semibold" id="evTitle">Event</h2>
      <p class="text-sm text-slate-600" id="evSubtitle"></p>
      <p class="text-sm text-slate-700 mt-1" id="evAddress"></p>
      <p class="text-sm text-slate-700" id="evTime"></p>
    </section>

    <div id="errBox" class="hidden mt-4 rounded-xl border border-red-200 bg-red-50 text-red-900 p-3 text-sm"></div>

    <section class="mt-6 grid md:grid-cols-2 gap-6 items-start">
      <form id="buyerForm" class="glass rounded-2xl border border-slate-200 p-5 grid gap-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">First name</label>
            <input id="firstName" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g., Thandi" required>
          </div>
          <div>
            <label class="text-sm text-slate-600">Last name</label>
            <input id="lastName" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g., Ndlovu" required>
          </div>
        </div>
        <div>
          <label class="text-sm text-slate-600">Email</label>
          <input id="buyerEmail" type="email" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="you@example.com" required>
        </div>
        <div>
          <label class="text-sm text-slate-600">Cell (South Africa)</label>
          <input id="buyerCell" inputmode="tel" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="(+27) 82 123 4567" required>
          <p class="text-[11px] text-slate-500 mt-1">Must be SA mobile (06/07/08). Auto-formats on blur.</p>
        </div>
      </form>

      <aside class="glass rounded-2xl border border-slate-200 p-5">
        <h3 class="text-lg font-semibold">Your order</h3>
        <div id="orderList" class="mt-3 text-sm text-slate-700 space-y-2"></div>
        <hr class="my-3">
        <div class="flex items-center justify-between font-semibold">
          <span>Total</span>
          <span id="total">R0</span>
        </div>
        <div class="mt-4 grid gap-2">
          <button id="payBtn" class="px-5 py-3 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700 disabled:opacity-40 disabled:cursor-not-allowed" disabled>Pay with Yoco</button>
          <p class="text-xs text-slate-500">You‚Äôll be redirected to Yoco to complete the payment.</p>
        </div>
      </aside>
    </section>
  </div>

<script>
(function(){
  'use strict';

  const CONFIG = {
    orgName: "Laudem Dei Chamber Choir",
    logoUrl: "https://laudemdeitickets.github.io/choir-tickets/logo.jpeg",
    event: {
      id: "choir-2025-spring-concert",
      title: "Spring Serenade Concert",
      subtitle: "An evening of choral gems",
      startISO: "2025-10-11T18:30:00+02:00",
      doorsISO: "2025-10-11T18:00:00+02:00",
      endISO:   "2025-10-11T20:00:00+02:00",
      venue: "St. Stithians Chapel",
      address: "40 Peter Place, Lyme Park, Sandton, 2191"
    },
    currency: 'ZAR',
    API_URL: 'https://choir-tickets.vercel.app/api/checkout'
  };

  const ZAR = new Intl.NumberFormat('en-ZA', { style:'currency', currency:'ZAR', maximumFractionDigits:0 });
  const fmt = (cents) => ZAR.format((cents||0)/100);
  const qs = (s,r)=> (r||document).querySelector(s);
  const toHuman = (iso)=> new Intl.DateTimeFormat(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}).format(new Date(iso));

  function saDigits(s){ return (s||'').replace(/[^0-9]+/g,''); }
  function saNormalizeNSN(raw){
    const d = saDigits(raw); if (!d) return null;
    let nsn = d;
    if (d.startsWith('27')) nsn = d.slice(2);
    else if (d.startsWith('0')) nsn = d.slice(1);
    if (nsn.length !== 9) return null;
    if (!/[678]/.test(nsn[0])) return null;
    return nsn;
  }
  function saFormatInternational(raw){
    const nsn = saNormalizeNSN(raw);
    if (!nsn) return null;
    return '(+27) ' + nsn.slice(0,2) + ' ' + nsn.slice(2,5) + ' ' + nsn.slice(5);
  }

  (function(){
    const ev = CONFIG.event;
    qs('#evTitle').textContent = ev.title;
    qs('#evSubtitle').textContent = ev.subtitle;
    qs('#evAddress').textContent = `üìç ${ev.venue} ‚Äî ${ev.address}`;
    qs('#evTime').textContent = `üóìÔ∏è ${toHuman(ev.startISO)} (doors ${new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(new Date(ev.doorsISO))})`;
  })();

  const DEFAULT_TICKETS = [{code:'GEN', name:'General Admission', qty:1, priceCents:20000}];
  function readCart(){
    try{
      const s = localStorage.getItem('ld_cart');
      const arr = JSON.parse(s||'[]');
      if (Array.isArray(arr) && arr.length) return arr;
    }catch(_){}
    return DEFAULT_TICKETS;
  }
  function totals(items){
    let total=0;
    for (const it of items) total += (it.priceCents||0) * (it.qty||0);
    return { total };
  }

  const items = readCart();
  function renderOrder(){
    const list = qs('#orderList'); list.innerHTML = '';
    if (!items.length) list.innerHTML = '<p class="text-slate-500">No tickets.</p>';
    for (const it of items){
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between';
      row.innerHTML = `<span>${it.name} √ó ${it.qty}</span><span>${fmt(it.priceCents*it.qty)}</span>`;
      list.appendChild(row);
    }
    const { total } = totals(items);
    qs('#total').textContent = fmt(total);
    qs('#payBtn').disabled = !(total>0);
  }

  function showError(msg){
    const box = qs('#errBox');
    box.textContent = msg || 'Error';
    box.classList.remove('hidden');
  }

  async function startCheckout(e){
    e.preventDefault();
    const firstName = qs('#firstName').value.trim();
    const lastName  = qs('#lastName').value.trim();
    const email     = qs('#buyerEmail').value.trim();
    const cellRaw   = qs('#buyerCell').value.trim();
    const cellFmt   = saFormatInternational(cellRaw);

    if (!firstName || !lastName || !email){ showError('Please complete your details.'); return; }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showError('Please enter a valid email address.'); return; }
    if (!cellFmt){ showError('Enter a South African mobile like (+27) 82 123 4567'); return; }
    qs('#buyerCell').value = cellFmt;

    const { total } = totals(items);
    if (total < 100) { showError('Total must be at least R1.00'); return; }

    const orderId = 'order_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4);

    // ‚úÖ Redirect to THANKS (not checkout.html)
    const successUrl = `https://laudemdeitickets.github.io/choir-tickets/thanks.html?paid=1&order=${encodeURIComponent(orderId)}&email=${encodeURIComponent(email)}&v=2`;
    const cancelUrl  = `https://laudemdeitickets.github.io/choir-tickets/index.html?cancelled=1&order=${encodeURIComponent(orderId)}`;

    try{
      const resp = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amountCents: total,
          description: `${CONFIG.event.title} ‚Äî ${items.map(i=>`${i.name}√ó${i.qty}`).join(', ')}`,
          successUrl, cancelUrl,
          meta: { orderId, eventId: CONFIG.event.id, buyer: { firstName, lastName, email, cell: cellFmt }, items }
        })
      });
      if (!resp.ok){
        const text = await resp.text();
        throw new Error(text || ('Checkout start failed: ' + resp.status));
      }
      const data = await resp.json();
      if (!data.redirectUrl) throw new Error('Missing redirectUrl from server');
      window.location.href = data.redirectUrl;
    } catch (e){
      console.error(e);
      showError('Could not start Yoco checkout. ' + (e.message||''));
      alert('Could not start Yoco checkout. Please try again or contact support.');
    }
  }

  function boot(){
    renderOrder();
    document.getElementById('payBtn').addEventListener('click', startCheckout);

    const cellEl = document.getElementById('buyerCell');
    const run = ()=>{ const f = saFormatInternational(cellEl.value); if (f){ cellEl.setCustomValidity(''); cellEl.value = f; } else { cellEl.setCustomValidity('Enter a South African mobile like (+27) 82 123 4567'); } };
    cellEl.addEventListener('blur', run);
    cellEl.addEventListener('change', run);
    cellEl.addEventListener('input', ()=>cellEl.setCustomValidity(''));
  }
  document.addEventListener('DOMContentLoaded', boot, { once:true });
})();
</script>
</body>
</html>
