<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout ‚Äî Laudem Dei Chamber Choir</title>
  <meta name="description" content="Checkout for Laudem Dei Chamber Choir tickets." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .glass { background: rgba(255,255,255,.72); backdrop-filter: blur(10px); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="bg-white text-slate-800">
  <div class="max-w-3xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://laudemdeitickets.github.io/choir-tickets/logo.jpeg" alt="Logo" class="w-12 h-12 rounded-xl ring-1 ring-slate-200 object-contain bg-white">
        <div>
          <h1 class="text-xl font-bold">Laudem Dei Chamber Choir</h1>
          <p class="text-sm text-slate-500">Secure checkout</p>
        </div>
      </div>
      <a href="index.html" class="text-sm underline hover:no-underline">Back to tickets</a>
    </header>

    <!-- Event Summary -->
    <section class="mt-6 glass rounded-2xl border border-slate-200 p-5">
      <h2 class="text-lg font-semibold">Spring Serenade Concert</h2>
      <p class="text-sm text-slate-600">An evening of choral gems</p>
      <p class="text-sm text-slate-700 mt-1">üìç St. Stithians Chapel ‚Äî 40 Peter Place, Lyme Park, Sandton, 2191</p>
      <p class="text-sm text-slate-700">üóìÔ∏è Sat, 11 Oct 2025 ‚Ä¢ 18:30 (doors 18:00)</p>
      <button id="icsBtn" class="mt-3 px-3 py-2 rounded-lg border hover:bg-white text-sm">Add to Calendar (.ics)</button>
    </section>

    <!-- Error / info banner -->
    <div id="errBox" class="hidden mt-4 rounded-xl border border-red-200 bg-red-50 text-red-900 p-3 text-sm"></div>
    <div id="infoBox" class="hidden mt-4 rounded-xl border border-amber-200 bg-amber-50 text-amber-900 p-3 text-sm"></div>

    <!-- Buyer details + order -->
    <section class="mt-6 grid md:grid-cols-2 gap-6 items-start">
      <form id="buyerForm" class="glass rounded-2xl border border-slate-200 p-5 grid gap-3" novalidate>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">First name</label>
            <input id="firstName" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g., Thandi" required>
          </div>
          <div>
            <label class="text-sm text-slate-600">Last name</label>
            <input id="lastName" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g., Ndlovu" required>
          </div>
        </div>
        <div>
          <label class="text-sm text-slate-600">Email</label>
          <input id="buyerEmail" type="email" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="you@example.com" required>
        </div>
        <div>
          <label class="text-sm text-slate-600">Cell (South Africa)</label>
          <input id="buyerCell" inputmode="tel" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="(+27) 82 123 4567" required>
          <p class="text-[11px] text-slate-500 mt-1">Must be SA mobile (06/07/08). Auto-formats on blur.</p>
        </div>
      </form>

      <aside class="glass rounded-2xl border border-slate-200 p-5">
        <h3 class="text-lg font-semibold">Your order</h3>
        <div id="orderList" class="mt-3 text-sm text-slate-700 space-y-2"></div>
        <hr class="my-3">
        <div class="flex items-center justify-between font-semibold">
          <span>Total</span>
          <span id="total">R0</span>
        </div>
        <div class="mt-4 grid gap-2">
          <button id="payBtn" class="px-5 py-3 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700 disabled:opacity-40 disabled:cursor-not-allowed" disabled>Pay with Yoco</button>
          <p class="text-xs text-slate-500">You‚Äôll be redirected to Yoco to complete the payment. Tickets appear only after successful payment.</p>
        </div>
      </aside>
    </section>

    <!-- Success / Ticket rendering -->
    <section id="successWrap" class="hidden mt-8">
      <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-900">
        <p class="font-semibold">Payment Confirmed</p>
        <p class="text-sm">Order <span id="orderIdOut"></span> ‚Äî Your tickets are below with QR codes.</p>
      </div>
      <div id="ticketsWrap" class="mt-3 text-sm"></div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button id="pngBtn" class="px-5 py-3 rounded-xl bg-slate-800 text-white font-semibold hover:opacity-90" type="button">Download PNG Tickets</button>
        <button id="shareAllBtn" class="px-5 py-3 rounded-xl border hover:bg-white" type="button">Share all via WhatsApp</button>
        <button id="doneBtn" class="px-5 py-3 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700" type="button">Done</button>
      </div>
    </section>
  </div>

  <script>
  (function(){
    'use strict';

    // ======= CONFIG =======
    const CONFIG = {
      orgName: "Laudem Dei Chamber Choir",
      logoUrl: "https://laudemdeitickets.github.io/choir-tickets/logo.jpeg",
      event: {
        id: "choir-2025-spring-concert",
        title: "Spring Serenade Concert",
        subtitle: "An evening of choral gems",
        startISO: "2025-10-11T18:30:00+02:00",
        doorsISO: "2025-10-11T18:00:00+02:00",
        endISO:   "2025-10-11T20:00:00+02:00",
        venue: "St. Stithians Chapel",
        address: "40 Peter Place, Lyme Park, Sandton, 2191"
      },
      currency: 'ZAR',
      API_URL: 'https://choir-tickets.vercel.app/api/checkout'
    };

    // ====== Utilities ======
    const ZAR = new Intl.NumberFormat('en-ZA', { style:'currency', currency:'ZAR', maximumFractionDigits:0 });
    const fmt = (cents) => ZAR.format((cents||0)/100);
    const qs = (s,r)=> (r||document).querySelector(s);
    const qsa = (s,r)=> Array.from((r||document).querySelectorAll(s));
    const toHuman = (iso)=> new Intl.DateTimeFormat(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}).format(new Date(iso));

    function info(msg){
      const box = qs('#infoBox'); box.textContent = msg; box.classList.remove('hidden');
    }
    function showError(msg){
      const box = qs('#errBox'); box.textContent = msg || 'Error'; box.classList.remove('hidden');
    }

    // Example cart (replace with your storage)
    const DEFAULT_TICKETS = [{code:'GEN', name:'General Admission', qty:1, priceCents:20000}];
    function readCart(){
      try{
        const s = localStorage.getItem('ld_cart');
        const arr = JSON.parse(s||'[]');
        if (Array.isArray(arr) && arr.length) return arr;
      }catch(_){}
      return DEFAULT_TICKETS;
    }
    function totals(items){
      let total=0;
      for (const it of items) total += (it.priceCents||0) * (it.qty||0);
      return { total };
    }

    // SA-only cell helpers
    function saDigits(s){ return (s||'').replace(/[^0-9]+/g,''); }
    function saNormalizeNSN(raw){
      const d = saDigits(raw); if (!d) return null;
      let nsn = d;
      if (d.startsWith('27')) nsn = d.slice(2);
      else if (d.startsWith('0')) nsn = d.slice(1);
      if (nsn.length !== 9) return null;
      if (!/[678]/.test(nsn[0])) return null;
      return nsn;
    }
    function saFormatInternational(raw){
      const nsn = saNormalizeNSN(raw);
      if (!nsn) return null;
      return '(+27) ' + nsn.slice(0,2) + ' ' + nsn.slice(2,5) + ' ' + nsn.slice(5);
    }
    function saNumberForWhatsApp(raw){
      const d = saDigits(raw); if (!d) return null;
      let nsn = d;
      if (d.startsWith('27')) nsn = d.slice(2);
      else if (d.startsWith('0')) nsn = d.slice(1);
      if (nsn.length !== 9 || !/[678]/.test(nsn[0])) return null;
      return '27' + nsn;
    }

    // Calendar (.ics)
    function downloadICS(){
      const ev = CONFIG.event;
      function toICSDate(iso){
        const d = new Date(iso);
        const pad = (n)=> String(n).padStart(2,'0');
        return d.getUTCFullYear() + pad(d.getUTCMonth()+1) + pad(d.getUTCDate())
          + 'T' + pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + pad(d.getUTCSeconds()) + 'Z';
      }
      const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Laudem Dei//Tickets//EN',
        'BEGIN:VEVENT',
        `UID:${ev.id}@laudemdei.org.za`,
        `DTSTAMP:${toICSDate(new Date().toISOString())}`,
        `DTSTART:${toICSDate(ev.startISO)}`,
        `DTEND:${toICSDate(ev.endISO)}`,
        `SUMMARY:${ev.title}`,
        `DESCRIPTION:${ev.subtitle}`,
        `LOCATION:${ev.venue}, ${ev.address}`,
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
      const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${ev.id}.ics`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // Render order UI
    const items = readCart();
    function renderOrder(){
      const list = qs('#orderList'); list.innerHTML = '';
      if (!items.length) list.innerHTML = '<p class="text-slate-500">No tickets.</p>';
      for (const it of items){
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between';
        row.innerHTML = `<span>${it.name} √ó ${it.qty}</span><span>${fmt(it.priceCents*it.qty)}</span>`;
        list.appendChild(row);
      }
      const { total } = totals(items);
      qs('#total').textContent = fmt(total);
      qs('#payBtn').disabled = !(total>0);
    }

    // === Start checkout (client ‚Üí your API ‚Üí Yoco) ===
    async function startCheckout(){
      const firstName = qs('#firstName').value.trim();
      const lastName  = qs('#lastName').value.trim();
      const emailEl   = qs('#buyerEmail');
      const email     = emailEl.value.trim();
      const cellRaw   = qs('#buyerCell').value.trim();
      const cellFmt   = saFormatInternational(cellRaw);

      if (!firstName || !lastName){ showError('Please complete your name.'); return; }
      if (!emailEl.checkValidity()){ emailEl.reportValidity(); return; }
      if (!cellFmt){ showError('Enter a South African mobile like (+27) 82 123 4567'); return; }
      qs('#buyerCell').value = cellFmt;

      const { total } = totals(items); // cents
      if (total < 100) { showError('Total must be at least R1.00'); return; }

      const orderId = 'order_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4);
      const successUrl = `${location.origin}${location.pathname}?paid=1&order=${encodeURIComponent(orderId)}`;
      const cancelUrl  = `${location.origin}${location.pathname}?cancelled=1&order=${encodeURIComponent(orderId)}`;

      try{
        const resp = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amountCents: total,
            description: `${CONFIG.event.title} ‚Äî ${items.map(i=>`${i.name}√ó${i.qty}`).join(', ')}`,
            successUrl, cancelUrl,
            meta: { orderId, eventId: CONFIG.event.id, buyer: { firstName, lastName, email, cell: cellFmt }, items }
          })
        });
        if (!resp.ok){
          const text = await resp.text();
          throw new Error(text || ('Checkout start failed: ' + resp.status));
        }
        const data = await resp.json();
        if (!data.redirectUrl) throw new Error('Missing redirectUrl from server');
        window.location.href = data.redirectUrl;
      } catch (e){
        console.error(e);
        showError('Could not start Yoco checkout. ' + (e.message||''));
      }
    }

    // === Claim tickets from webhook token (required) ===
    async function claimTicketsFromToken() {
      const params = new URLSearchParams(location.search);
      const token = params.get('token');
      if (!token) return false;

      try{
        const verifyUrl = 'https://choir-tickets.vercel.app/api/tickets/verify?token=' + encodeURIComponent(token);
        const resp = await fetch(verifyUrl, { method: 'GET' });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || 'Verify failed');

        const p = data.payload;
        window.__SIGNED_ITEMS__ = Array.isArray(p.items) ? p.items : [];

        const firstName = (p.buyer?.firstName || '').trim();
        const lastName  = (p.buyer?.lastName  || '').trim();
        const email     = (p.buyer?.email     || '').trim();
        const cellFmt   = (p.buyer?.cell      || '').trim();

        await generateTickets({ orderId: p.orderId, firstName, lastName, email, cellFmt });
        return true;
      }catch(e){
        console.error(e);
        showError('Could not verify ticket token. ' + (e.message||''));
        return false;
      }
    }

    // Ticket rendering (ONLY uses signed items)
    async function generateTickets({ orderId, firstName, lastName, email, cellFmt }){
      const wrap = qs('#ticketsWrap'); wrap.innerHTML = '';

      const sourceItems = (window.__SIGNED_ITEMS__ && Array.isArray(window.__SIGNED_ITEMS__) && window.__SIGNED_ITEMS__.length)
        ? window.__SIGNED_ITEMS__
        : [];

      if (!sourceItems.length){
        showError('No signed tickets to display yet. If you have paid, please use the claim link sent after payment.');
        return;
      }

      for (const it of sourceItems){
        const tkt = it.ticketId;
        const row = document.createElement('div');
        row.className = 'grid grid-cols-[1fr,110px] gap-3 border border-slate-200 rounded-lg px-3 py-3 mt-2 items-center';
        row.setAttribute('data-ticket-id', tkt);
        row.innerHTML = `
          <div>
            <div class='flex items-center gap-2'>
              <img src='${CONFIG.logoUrl}' crossorigin='anonymous' class='w-7 h-7 rounded-md ring-1 ring-slate-200 object-contain' alt='logo' />
              <div class='font-medium'>${it.name}</div>
            </div>
            <div class='text-xs text-slate-500'>${tkt}</div>
            <div class='text-xs'>${fmt(it.priceCents)}</div>
            <div class='text-xs text-slate-600 mt-1'>${toHuman(CONFIG.event.startISO)} ‚Ä¢ ${CONFIG.event.venue}</div>
            <div class='text-[11px] text-slate-500'>${CONFIG.event.address}</div>
            <div class='text-[11px] text-slate-500 mt-1'>Buyer: ${firstName} ${lastName} ‚Ä¢ ${cellFmt}</div>
          </div>
          <div id='qr_${tkt}' class='justify-self-end'></div>
        `;
        const qrDivId = 'qr_'+tkt;
        const wrapEl = document.createElement('div');
        wrap.appendChild(row);

        const qrDiv = row.querySelector('#'+qrDivId);
        const payload = JSON.stringify({
          order: orderId, ticket: tkt,
          event: CONFIG.event.id, title: CONFIG.event.title,
          dateISO: CONFIG.event.startISO, venue: CONFIG.event.venue, address: CONFIG.event.address,
          firstName, lastName, email, cell: cellFmt
        });
        new QRCode(qrDiv, { text: payload, width:110, height:110, correctLevel: QRCode.CorrectLevel.M });
        await new Promise(r => setTimeout(r, 10));
      }

      qs('#orderIdOut').textContent = orderId;
      qs('#successWrap').classList.remove('hidden');

      // PNG export
      qs('#pngBtn').onclick = async function(){
        const rows = qsa('#ticketsWrap > div'); if (!rows.length) { alert('No tickets to export.'); return; }
        for (const row of rows){
          const prev = { backgroundColor: row.style.backgroundColor, borderRadius: row.style.borderRadius, border: row.style.border, boxShadow: row.style.boxShadow, overflow: row.style.overflow, padding: row.style.padding };
          row.style.backgroundColor = '#ffffff'; row.style.borderRadius = '16px'; row.style.border = '2px solid #e2e8f0'; row.style.boxShadow = '0 8px 20px rgba(2,132,199,0.08)'; row.style.overflow = 'hidden'; row.style.padding = row.style.padding || '12px 16px';
          const canvas = await html2canvas(row, { backgroundColor: null, scale: 2 });
          row.style.backgroundColor = prev.backgroundColor; row.style.borderRadius = prev.borderRadius; row.style.border = prev.border; row.style.boxShadow = prev.boxShadow; row.style.overflow = prev.overflow; row.style.padding = prev.padding;
          const dataUrl = canvas.toDataURL('image/png');
          const a = document.createElement('a'); const tid = row.dataset.ticketId || 'ticket';
          a.href = dataUrl; a.download = `${CONFIG.event.id}_${tid}.png`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
          await new Promise(r=>setTimeout(r,120));
        }
      };

      // Share-all via WhatsApp
      qs('#shareAllBtn').onclick = async function(){
        const rows = qsa('#ticketsWrap > div'); if (!rows.length) { alert('No tickets to share.'); return; }
        const cellFmtNow = qs('#buyerCell').value.trim();
        const waNum = saNumberForWhatsApp(cellFmtNow);
        const files = [];
        let i=0;
        for (const row of rows){
          const canvas = await html2canvas(row, { backgroundColor:'#ffffff', scale:2, useCORS:true });
          const blob = await new Promise(res=> canvas.toBlob(b=>res(b), 'image/png'));
          if (!blob) continue;
          const tid = row.dataset.ticketId || `ticket_${++i}`;
          files.push(new File([blob], `${CONFIG.event.id}_${tid}.png`, { type:'image/png' }));
          if (files.length>=10) break;
        }
        const text = `üéüÔ∏è ${CONFIG.event.title}\nOrder ${orderId}\nTickets attached (${files.length}).`;
        if (files.length && navigator.canShare && navigator.canShare({ files })){
          await navigator.share({ files, title: `${CONFIG.event.title} tickets`, text });
          return;
        }
        if (!waNum){ alert('Invalid SA mobile for WhatsApp'); return; }
        const encoded = encodeURIComponent(`${text}\n(Your device cannot share files from the browser. Please download PNG and send via WhatsApp.)`);
        window.open(`https://wa.me/${waNum}?text=${encoded}`, '_blank');
      };

      qs('#doneBtn').onclick = ()=> window.location.href = 'index.html';
    }

    // === BOOT ===
    async function boot(){
      renderOrder();
      qs('#payBtn').addEventListener('click', (e)=>{ e.preventDefault(); startCheckout(); });
      qs('#icsBtn').addEventListener('click', downloadICS);

      const cellEl = qs('#buyerCell');
      const run = ()=>{ const f = saFormatInternational(cellEl.value); if (f){ cellEl.setCustomValidity(''); cellEl.value = f; } else { cellEl.setCustomValidity('Enter a South African mobile like (+27) 82 123 4567'); } };
      cellEl.addEventListener('blur', run);
      cellEl.addEventListener('change', run);
      cellEl.addEventListener('input', ()=>cellEl.setCustomValidity(''));

      // Only generate tickets when a valid token is present
      if (await claimTicketsFromToken()) return;

      // If user returned from Yoco without token, inform them
      const params = new URLSearchParams(location.search);
      if (params.get('paid') === '1') {
        info('Payment successful. Your ticket link was generated and sent to your email. Please open the link on this device to display your tickets.');
      }
    }
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  })();
  </script>
</body>
</html>
