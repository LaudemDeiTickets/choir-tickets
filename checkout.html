<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout — Ticket Confirmation</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--soft:#e2e8f0;--ink:#0b1220;--muted:#667085;--brand:#0ea5e9;}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--soft);border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .pad{padding:16px}
    h1,h2{margin:8px 0 12px}
    .row{display:flex;flex-wrap:wrap;gap:16px}
    .col{flex:1 1 260px}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--soft);margin:12px 0}
    .qrBox{display:grid;place-items:center;padding:12px;border:1px dashed var(--soft);border-radius:12px;background:#fff}
    .warn{color:#b45309}
    .ok{color:#166534}
    .err{color:#991b1b}
    .mini{font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#e0f2fe;color:#075985;font-weight:700}
    .grid2{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:860px){.grid2{grid-template-columns:2fr 1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="pad" style="display:flex;align-items:center;justify-content:space-between">
      <h1>Order Confirmation</h1>
      <span class="badge">Laudem Dei • Tickets</span>
    </header>

    <main class="grid2">
      <section class="card pad">
        <h2>Order Summary</h2>
        <!--
          If your existing checkout already renders an order summary element,
          keep its id and data-* attributes so the script can read values from it.
          The script also supports window.checkout = { buyer_name, buyer_email, buyer_cell, concert_info, order_number }.
        -->
        <div id="orderSummary"
             data-buyer-name=""
             data-buyer-email=""
             data-buyer-cell=""
             data-concert-info=""
             data-order-number="">
          <!-- Replace this block with your existing order details UI -->
          <div class="row">
            <div class="col">
              <div><strong>Buyer</strong></div>
              <div class="mini muted">Name / Email / Cell will appear from checkout</div>
            </div>
            <div class="col">
              <div><strong>Concert</strong></div>
              <div class="mini muted">Concert info from checkout</div>
            </div>
          </div>
          <div class="divider"></div>
          <div><strong>Order Number</strong>: <span id="orderNumText" class="muted">—</span></div>
        </div>

        <div class="divider"></div>
        <h3>Ticket QR Code</h3>
        <p class="mini muted">This QR encodes exactly these fields: <code>buyer_name</code>, <code>buyer_email</code>, <code>buyer_cell</code>, <code>concert_info</code>, <code>order_number</code>.</p>
        <div id="ticketQR" class="qrBox">
          <noscript class="err">Enable JavaScript to view your QR code.</noscript>
        </div>
        <p id="qrMsg" class="mini muted" style="text-align:center;margin-top:8px"></p>
        <p id="sheetMsg" class="mini muted" style="text-align:center;margin-top:6px"></p>
      </section>

      <aside class="card pad">
        <h3>What next?</h3>
        <ol class="mini">
          <li>Screenshot or save the QR to your phone.</li>
          <li>Bring it to the venue. The usher will scan it to check you in.</li>
        </ol>
        <div class="divider"></div>
        <h4>Debug</h4>
        <button id="showPayloadBtn">Show QR payload</button>
        <pre id="payloadOut" class="mini" style="white-space:pre-wrap"></pre>
      </aside>
    </main>
  </div>

  <!-- QR libraries: pick one (A recommended) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script> -->

  <script>
  // ===== Google Sheet endpoint (replace with your Apps Script Web App URL) =====
  const SHEET_ENDPOINT = "REPLACE_WITH_YOUR_WEB_APP_URL"; // e.g. https://script.google.com/macros/s/AKfyc.../exec
  const SHEET_SECRET   = "optional-shared-secret";        // optional: set in Apps Script and here

  // ----- Helpers -----
  const REQUIRED = ['buyer_name','buyer_email','buyer_cell','concert_info','order_number'];
  const $ = (id)=>document.getElementById(id);
  function qp(name){ try{ return new URLSearchParams(location.search).get(name)||''; }catch{ return ''; } }

  function readFromDataAttrs(){
    const el = document.getElementById('orderSummary'); if(!el) return {};
    return {
      buyer_name:   el.dataset.buyerName   || '',
      buyer_email:  el.dataset.buyerEmail  || '',
      buyer_cell:   el.dataset.buyerCell   || '',
      concert_info: el.dataset.concertInfo || '',
      order_number: el.dataset.orderNumber || ''
    };
  }

  function readFromQuery(){
    return {
      buyer_name:   qp('buyer_name')   || qp('name'),
      buyer_email:  qp('buyer_email')  || qp('email'),
      buyer_cell:   qp('buyer_cell')   || qp('cell') || qp('phone'),
      concert_info: qp('concert_info') || qp('concert'),
      order_number: qp('order_number') || qp('order_no') || qp('order') || qp('tkt')
    };
  }

  function firstNonEmpty(...objs){
    const out = {}; for(const o of objs){ for(const [k,v] of Object.entries(o||{})){ if(!out[k] && v){ out[k]=v; } } }
    return out;
  }

  function validatePayload(p){
    const missing = REQUIRED.filter(k=>!p[k] || String(p[k]).trim()==='');
    return { ok: missing.length===0, missing };
  }

  function renderQR(text){
    const el = $('ticketQR'); el.innerHTML = '';
    if(window.QRCode){
      new QRCode(el, { text, width:256, height:256, correctLevel: QRCode.CorrectLevel.M });
    } else if (window.QRCode && window.QRCode.toCanvas){
      const canvas = document.createElement('canvas'); el.appendChild(canvas);
      window.QRCode.toCanvas(canvas, text, { width:256, errorCorrectionLevel:'M' }, (err)=>{ if(err) console.error(err); });
    } else {
      el.textContent = 'QR library not found';
    }
  }

  function buildPayload(){
    // Priority: window.checkout -> data-* -> query params
    const fromGlobal = (window.checkout && typeof window.checkout==='object') ? window.checkout : {};
    const attrs = readFromDataAttrs();
    const query = readFromQuery();
    const payload = firstNonEmpty(fromGlobal, attrs, query);
    return {
      buyer_name:   payload.buyer_name   || '',
      buyer_email:  payload.buyer_email  || '',
      buyer_cell:   payload.buyer_cell   || '',
      concert_info: payload.concert_info || '',
      order_number: payload.order_number || ''
    };
  }

  function showStatus(msg, cls='muted'){ const p=$('qrMsg'); p.className = 'mini '+cls; p.textContent = msg; }
  function showSheetStatus(msg, cls='muted'){ const p=$('sheetMsg'); if(!p) return; p.className = 'mini '+cls; p.textContent = msg; }

  async function sendToSheet(payload){
    if(!SHEET_ENDPOINT || /REPLACE_WITH_YOUR_WEB_APP_URL/.test(SHEET_ENDPOINT)){
      showSheetStatus('Sheet logging disabled (no endpoint).', 'muted');
      return { ok:false, reason:'no-endpoint' };
    }
    const body = {
      ...payload,
      ts: new Date().toISOString(),
      user_agent: navigator.userAgent,
      referrer: document.referrer || '',
      secret: SHEET_SECRET || ''
    };
    try{
      const res = await fetch(SHEET_ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      const ok = res.ok;
      let data = null; try{ data = await res.json(); }catch{ /* ignore */ }
      if(ok && (data?.ok !== false)){
        showSheetStatus('Saved to Google Sheet ✓', 'ok');
        return { ok:true };
      }
      showSheetStatus('Could not save to Sheet (server said no).', 'warn');
      return { ok:false };
    } catch(err){
      showSheetStatus('Offline or endpoint unreachable. Will retry on next load.', 'warn');
      return { ok:false, error: String(err) };
    }
  }

  async function generate(){
    const payload = buildPayload();
    const v = validatePayload(payload);
    if(!v.ok){
      showStatus('Missing: '+v.missing.join(', '), 'warn');
    } else {
      showStatus('QR ready. Save or screenshot this code.', 'ok');
    }
    const text = JSON.stringify(payload);
    renderQR(text);
    const on = document.getElementById('orderNumText'); if(on) on.textContent = payload.order_number || '—';

    // Fire-and-forget: write to Google Sheet once payload seems valid
    if(v.ok){ await sendToSheet(payload); }
    return payload;
  }

  // Bootstrap
  (async()=>{ await generate(); })();
  $('showPayloadBtn').onclick = ()=>{ $('payloadOut').textContent = JSON.stringify(buildPayload(), null, 2); };
  </script>
</body>
</html>
